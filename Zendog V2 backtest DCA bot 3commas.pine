Script Name: Zendog V2 backtest DCA bot 3commas
Author: zendog123
Description: Hi everyone,
After a few iterations and additional implemented features this version of the Backtester is now open source.

The Strategy is a Backtester for 3commas DCA bots. The main usage scenario is to plugin your external indicator, and backtest it using different DCA settings.
Before using this script please make sure you read these explanations and make sure...
PineScript code:

Pine Scriptâ„¢ strategy
Zendog V2 backtest DCA bot 3commas
//IMPROVEMENTS/TODO:
//-  for  better  execution  time  use  static  bgcolor  values
//-  remove  disposable  variables
//-  avoid  concatenating  strings
//-  improve  UI  code  /  tables  with  functions  /  lighter  approaches
//-  fix  bugs  when  BO/SL/TP  are  on  the  same  candle
//@author  zendog123
//@version=4
strategy(title="Zendog  V2  backtest  DCA  bot  3commas",  shorttitle="Zendog  V2  DCA",  overlay=true,
      max_labels_count=500,  pyramiding=99,  initial_capital=10000,  calc_on_order_fills=false,
          commission_type=strategy.commission.percent,  commission_value=0.075)
//used  for  labels
cfg_theme                      =  input(defval="dark",  title="Chart  theme",
                                                          options=["light",  "dark"])
theme_text_color        =  cfg_theme  ==  "dark"  ?  color.white  :  color.black
f_print(_text)  =>
        //  Create  label  on  the  first  bar.
        var  _label  =  label.new(x=bar_index,  y=na,  text=tostring(_text),  xloc=xloc.bar_index,  yloc=yloc.price,  color=color.blue,
              style=label.style_label_up,  textcolor=theme_text_color,  size=size.normal,  textalign=text.align_left)
        //  On  next  bars,  update  the  label's  x  and  y  position,  and  the  text  it  displays.
        if  barstate.islastconfirmedhistory
                label.set_xy(_label,  bar_index,  low*0.99)
                label.set_text(_label,  tostring(_text))
//----------------------------------------------
//STRATEGY  STUFF  STARTS  HERE
//deal  start
deal_start_condition                =  false
deal_start_type                          =  input(defval="RSI-7",  title="Deal  start  trigger",
                                                          options=["RSI-7",  "External  Indicator"],  group="Deal  start  condition")
string  rsi_start_operation    =  input(defval="<=",  title="RSI-7",  type=input.string,  group="Deal  start  condition",
                                                          options=["<=",  ">="])
rsi_start_value                          =  input(type=input.integer,  defval=30,  title="RSI-7  Value",  group="Deal  start  condition")
float  deal_start_source          =  input(defval=close,  title="Start  Indicator  Source  And  Value",  type=input.source,  group="Dealstartcondition")
stringdeal_start_operation=input(defval="=",title="",type=input.string,group="Dealstartcondition",
options=["<=","=",">="])
floatdeal_start_value=input(defval=-99999,title="",type=input.float,group="Dealstartcondition")
//dealstop
//deal_stop_condition=false
//deal_stop_type=input(defval="Takeprofit",title="Dealstoptrigger",
//options=["Takeprofit","ExternalIndicator"],
//group="Dealstopcondition")
//floatdeal_stop_source=input(defval=close,title="StopIndicatorSourceAndValue",type=input.source,group="Dealstopcondition")
//stringdeal_stop_operation=input(defval="=",title="",type=input.string,group="Dealstopcondition",
//options=["<=","=",">="])
//floatdeal_stop_value=input(defval=-99999,title="",type=input.float,group="Dealstopcondition")
//---------DEALSTARTCONDITION----------
//RSI-7
if(deal_start_type=="RSI-7")and(rsi_start_operation=="<=")
deal_start_condition:=(rsi(close,7)<=rsi_start_value)
elseif(deal_start_type=="RSI-7")and(rsi_start_operation==">=")
deal_start_condition:=(rsi(close,7)>=rsi_start_value)
//MAYBEFOUNDABUG-->Leaveallif'sonthislevelotherwisetheydonotwork
elseif((deal_start_type=="ExternalIndicator")and(deal_start_value!=-99999)
and(deal_start_operation=="=")and(deal_start_source==deal_start_value))
deal_start_condition:=true
elseif((deal_start_type=="ExternalIndicator")and(deal_start_value!=-99999)
and(deal_start_operation=="<=")and(deal_start_source<=deal_start_value))
deal_start_condition:=true
elseif((deal_start_type=="ExternalIndicator")and(deal_start_value!=-99999)
and(deal_start_operation==">=")and(deal_start_source>=deal_start_value))
deal_start_condition:=true
else
deal_start_condition:=false
//-----------------------------------------
//---------DEALSTOPCONDITION-----------
//if((deal_stop_type=="ExternalIndicator")and(deal_stop_value!=-99999)
//and(deal_stop_operation=="=")and(deal_stop_source==deal_stop_value))
//deal_stop_condition:=true
//elseif((deal_stop_type=="ExternalIndicator")and(deal_stop_value!=-99999)
//and(deal_stop_operation=="<=")and(deal_stop_source<=deal_stop_value))
//deal_stop_condition:=true
//elseif((deal_stop_type=="ExternalIndicator")and(deal_stop_value!=-99999)
//and(deal_stop_operation==">=")and(deal_stop_source>=deal_stop_value))
//deal_stop_condition:=true
//else
//deal_stop_condition:=false
//-----------------------------------------
//strategytimeframelimitation(runjustbetweenspecificdates)
limit_date_range=input(title="LimitDateRange",type=input.bool,defval=true,group="Backtestdaterange")
//Inputoptionsthatconfigurebacktestdaterange
start_time=input(defval=timestamp("01Aug202100:00+0000"),title="StartTime",
type=input.time,group="Backtestdaterange")
end_time=input(defval=timestamp("31Dec202100:00+0000"),title="EndTime",
type=input.time,group="Backtestdaterange")
in_date_range=true
iflimit_date_range
in_date_range:=time>=start_timeandtime<=end_time
else
in_date_range:=true
cfg_strategy_type=input(title="StrategyType",defval="long",options=["long","short"],group="Strategysettings")
varboolIS_LONG=cfg_strategy_type=="long"
floatcfg_base_order_size_usd=input(title="Baseordersize",type=input.float,defval=1000,step=1000,group="Strategysettings")
floatcfg_safety_order_size_usd=input(title="Safetyordersize",type=input.float,defval=700,step=100,group="Strategysettings")
cfg_take_profit_type=input(title="TakeProfitType",defval="%Fromtotalvolume",
options=["%Frombaseorder","%Fromtotalvolume"],
group="Strategysettings")
floatcfg_take_profit_perc=input(title="TakeProfit(%)",type=input.float,minval=0.0,step=0.1,defval=2,group="Strategysettings")
boolcfg_enable_stop_loss=input(title="EnableStopLoss",type=input.bool,defval=false,group="Strategysettings")
floatcfg_stop_loss_perc=input(title="StopLoss(%)",type=input.float,minval=0.0,step=0.1,defval=20,group="Strategysettings")
floatcfg_max_safety_orders=input(title="MaxSafetyTradesCount",type=input.float,defval=5,group="Strategysettings")
floatcfg_safety_order_price_deviation_perc=input(title="PriceDeviationToOpenSafetyTrades(%)",type=input.float,minval=0.0,
step=0.1,defval=3,group="Strategysettings")
floatcfg_safety_order_volume_scale=input(title="SafetyOrderVolumeScale",type=input.float,defval=1,step=0.1,group="Strategysettings")
floatcfg_safety_order_price_step_scale=input(title="SafetyOrderStepScale",type=input.float,defval=1,step=0.1,group="Strategysettings")
intcfg_planb_timeout=input(title="PLAN-BTimeout",type=input.integer,defval=1,step=1,group="PLAN-B",
tooltip="TimeouttoactivatePLAN-B.Use'none'inthedropdownbelowtodisablePLAN-B")
cfg_planb_timeout_type=input(title="",defval="none",options=["none","min","hour","day"],group="PLAN-B")
cfg_planb_action=input(title="PLAN-BAction",defval="none",options=["none","paintonly","closedeal"],group="PLAN-B")
floatcfg_planb_take_profit=input(title="PLAN-BCloseDeal(%)",type=input.float,defval=0.5,step=0.1,group="PLAN-B",
tooltip="Alternative%fromtotalvolume(versusposition_avg_size)tousewhenPLAN-Bisactivated.\nItiseitherapositive%foralternativeTPoranegative%foralternativeSL")
get_planb_timeout()=>
float_timeout=0
ifcfg_planb_timeout_type=="day"
_timeout:=cfg_planb_timeout*86400000
elseifcfg_planb_timeout_type=="hour"
_timeout:=cfg_planb_timeout*3600000
elseifcfg_planb_timeout_type=="min"
_timeout:=cfg_planb_timeout*60000
//calculateonlyonce
varfloatglb_planb_timeout=get_planb_timeout()
string_tooltip_bot_control="IfthisisenabledthestrategycancontrolsomebotoperationsviaWebhookcalls.\nThestrategywillcontroldealstartanddealstopfromanyreason(takeprofit,stoplossortimeout),executedatmarketprice.\nItisunabletocontrolanySafetyOrders,buttheycanandshouldbereplicatedbythesettingsofthe3commasbot.\n\nToenableWebhookcalls,checkthisoption,completeBotidandEmailToken.Afterthestrategyisconfigured,createanalertonthestrategy,selectOrderfillsonly,andinthemessagefieldsimplyinput{{strategy.order.alert_message}}."
boolcfg_enable_bot_control=input(title="EnableBotControlViaWebhook",type=input.bool,defval=false,group="3commasBotSettings",
tooltip=_tooltip_bot_control)
stringcfg_bot_id=input(title="Botid",type=input.string,defval="",group="3commasBotSettings")
stringcfg_email_token=input(title="Emailtoken",type=input.string,defval="",group="3commasBotSettings")
boolcfg_exec_deal_start=input(title="Dealstart",type=input.bool,defval=true,group="3commasBotSettings")
boolcfg_exec_take_profit=input(title="Takeprofit",type=input.bool,defval=true,group="3commasBotSettings")
boolcfg_exec_stop_loss=input(title="StopLoss",type=input.bool,defval=true,group="3commasBotSettings")
boolcfg_exec_planb_timeout=input(title="PLAN-B",type=input.bool,defval=true,group="3commasBotSettings")
floatcfg_commision_percent=input(title="Commision(%)",type=input.float,minval=0.0,step=0.001,defval=0.075,group="Broker")
//visuals
intcfg_decimals=input(title="DecimalsForDisplay",type=input.integer,defval=2,group="Visuals")
boolcfg_show_pnl_labels=input(title="ShowPnLLabels",type=input.bool,defval=true,group="Visuals")
boolcfg_show_stats_table=input(title="ShowTableWithStatistics",type=input.bool,defval=true,group="Visuals")
boolcfg_show_settings_table=input(title="ShowTableWithStrategySettings",type=input.bool,defval=true,group="Visuals")
boolcfg_show_step_table=input(title="ShowTableWithStepsSimilarTo3commas",type=input.bool,defval=false,group="Visuals",
tooltip="MakesuretheTablewithStrategySettingsisdisabled")
floatcfg_steps_bo_price=input(title="BOEntryPriceForStepsTable",type=input.float,defval=0,group="Visuals")
//howmanysafetyorderswereplacedincurrenttrade
varintcount_placed_safety_orders=0
//howmanysafetyorderswereexecutedincurrenttrade
varintcount_executed_safety_orders=0
varfloatglb_take_profit_price=na
varfloatglb_planb_timeout_price=na
varfloatglb_stop_loss_price=na
varfloatglb_base_order_price=na
varfloatglb_base_order_qty=na
varfloatglb_next_safety_order_price=na
varfloatglb_next_safety_order_qty=na
//calculatedbasedonBOsize,SOsize,andsteps
varfloatglb_required_capital=na
//usedforstatsandtocalculatecommision
varfloatglb_total_volume=0
//weusethesevariablestorememberpositionsizeanduseit
//tocalculatepnlafterthedealwasclosed
varfloatglb_current_deal_position_size=na
varfloatglb_current_deal_avg_price=na
//usedtotrytoobtainrealpricesforordersalreadyexecuted
varfloatglb_current_deal_prev_position_size=na
varfloatglb_strategy_prev_netprofit=0
//Theseremainglobalbecauseofexecutionimprovement
varfloatglb_current_deal_close_value=0
varfloatglb_current_deal_pnl=0
//0-notindeal
//1-baseorderexecuted
//2-safetyorderexecuted
varintlast_performed_action=0
//arraythatholdsstatsforusedSO
varint[]statsarray_safety_orders=array.new_int(0)
varint[]statsarray_safety_orders_timeout=array.new_int(0)
varintglb_dealstart_bar_index=0
varint[]statsarray_no_of_bars=array.new_int(0)
varintglb_dealstart_bar_time=0
varfloat[]statsarray_no_of_days=array.new_float(0)
varfloatstats_max_days_in_deal=0
varstats_max_days_in_deal_start_time=0
varstats_max_days_in_deal_close_time=0
varboolfirstdeal_started=false
varintfirstdeal_bar_index=0
varfloatfirstdeal_start_price=0
varfirstdeal_start_time=0
varintlastdeal_close_bar_index=0
varlastdeal_close_time=0
//buyandholdstats
varfloatbh_start_price=0
varbh_start_time=0
varfloatbh_end_price=0
varbh_end_time=0
varboolbh_calculation_started=false
//maxdrawndowninadealvsavgpositionprice
varfloatstats_max_drawdown=0
varstats_max_drawdown_time=0
varfloatstats_max_drawdown_equity_percent=0
//biggestpercentdeviationvsbaseorder
varfloatstats_biggest_dev=0
varstats_biggest_dev_time=0
varfloatstats_deals_started=0
varfloatstats_deals_finished=0
varfloatstats_deals_stop_loss_finished=0
varfloatstats_deals_take_profit_finished=0
varfloatstats_deals_timeout_finished=0
//willkeepprofit/losses
varfloat[]statsarray_winning_deals_pnl=array.new_float(0)
varfloat[]statsarray_losing_deals_pnl=array.new_float(0)
varfloat[]statsarray_timeout_deals_pnl=array.new_float(0)
//FUNCTIONS
//so_index0isforBO,from1..nonitisforSOn
//calculatespercentsonoadjustmentforlongvsshort
stepped_deviation(so_index)=>
float_stepped_deviation=0
ifso_index>0
for_i=1toso_index
_stepped_deviation+=cfg_safety_order_price_deviation_perc*pow(cfg_safety_order_price_step_scale,_i-1)
else
_stepped_deviation:=0
valid_stop_loss()=>
bool_valid=false
ifcfg_enable_stop_loss
//stoplosspercentisbiggerthanlastsafetyorderpercent
ifcfg_stop_loss_perc>stepped_deviation(cfg_max_safety_orders)
_valid:=true
else
_valid:=false
else
_valid:=false
next_so_price(so_index,_bo_price)=>
float_stepped_deviation=stepped_deviation(so_index)
ifIS_LONG
float_next_so_price=_bo_price*(1-(_stepped_deviation/100))
else
float_next_so_price=_bo_price*(1+(_stepped_deviation/100))
next_so_size_usd(so_index)=>
float_next_so_size_usd=cfg_safety_order_size_usd*pow(cfg_safety_order_volume_scale,so_index-1)
next_so_qty(so_index,_bo_price)=>
float_next_so_size_usd=next_so_size_usd(so_index)
float_next_so_qty=_next_so_size_usd/next_so_price(so_index,_bo_price)
is_planb_timeout()=>
_res=false
ifna(glb_dealstart_bar_time)==false
if(time-glb_dealstart_bar_time)>=glb_planb_timeout
_res:=true
else
_res:=false

get_required_capital()=>
float_total_buy=0
ifcfg_max_safety_orders>0
_total_buy+=cfg_base_order_size_usd
for_i=1tocfg_max_safety_orders
_total_buy+=next_so_size_usd(_i)
else
_total_buy+=cfg_base_order_size_usd
get_days(start_time,end_time)=>
time_diff=end_time-start_time
diff_days=round(time_diff/86400000,1)
get_timestring_from_seconds(seconds)=>
ifseconds>=86400
string_string=tostring(round(seconds/86400,1))+"days"
elseifseconds>=3600
string_string=tostring(round(seconds/3600,1))+"hours"
else
string_string=tostring(round(seconds/60,1))+"mins"
get_timestring_from_days(days)=>
get_timestring_from_seconds(days*86400)
get_timespan_string(start_time,end_time)=>
_seconds_diff=(end_time-start_time)/1000
get_timestring_from_seconds(_seconds_diff)
//f_print(get_timestring_from_days(0.5)+"\n"+get_timestring_from_days(0.01)+"\n"+get_timestring_from_days(0.7))
get_commission_for_volume(vol)=>
_commision=vol*cfg_commision_percent/100
get_final_pnl_new()=>
float_pnl=0
ifarray.size(statsarray_losing_deals_pnl)>0
_pnl+=array.sum(statsarray_losing_deals_pnl)
ifarray.size(statsarray_winning_deals_pnl)>0
_pnl+=array.sum(statsarray_winning_deals_pnl)
//addorsubstractcurrentdealopenprofit
//commissionisalreadysubstracted
_pnl:=_pnl+strategy.openprofit
get_final_pnl_prct_new()=>
get_final_pnl_new()*100/glb_required_capital
take_profit_price()=>
ifcfg_take_profit_type=="%Fromtotalvolume"
ifIS_LONG
_tp_price=strategy.position_avg_price*(1+cfg_take_profit_perc/100)
else
_tp_price=strategy.position_avg_price*(1-cfg_take_profit_perc/100)
elseifcfg_take_profit_type=="%Frombaseorder"
ifIS_LONG
_tp_size_usd=cfg_base_order_size_usd*cfg_take_profit_perc/100
_tp_price=((strategy.position_avg_price*strategy.position_size)+_tp_size_usd)/strategy.position_size
else
_tp_size_usd=cfg_base_order_size_usd*cfg_take_profit_perc/100
_tp_price=((strategy.position_avg_price*strategy.position_size)-_tp_size_usd)/strategy.position_size
planb_timeout_price()=>
ifIS_LONG
_price=strategy.position_avg_price*(1+float(cfg_planb_take_profit)/100)
else
_price=strategy.position_avg_price*(1-float(cfg_planb_take_profit)/100)

stop_loss_price()=>
ifIS_LONG
glb_base_order_price*(1-cfg_stop_loss_perc/100)
else
glb_base_order_price*(1+cfg_stop_loss_perc/100)
is_condition_take_profit()=>
ifIS_LONG
(high>=glb_take_profit_price)and(strategy.position_size==0)
else
(low<=glb_take_profit_price)and(strategy.position_size==0)
is_condition_planb_price()=>
ifIS_LONG
(high>=glb_planb_timeout_price)and(strategy.position_size==0)
else
(low<=glb_planb_timeout_price)and(strategy.position_size==0)
is_condition_stop_loss()=>
bool_cond=false
ifvalid_stop_loss()
ifIS_LONG
_cond:=(low<=glb_stop_loss_price)and(strategy.position_size==0)
else
_cond:=(high>=glb_stop_loss_price)and(strategy.position_size==0)
else
_cond:=false
get_current_dev_vs_bo_price()=>
ifIS_LONG
_dev=(low*100/glb_base_order_price)-100
else
_dev=100-(high*100/glb_base_order_price)
get_current_drawdown_equity()=>
_deal_total_value=strategy.position_size*strategy.position_avg_price
ifIS_LONG
_drawdown_actual_value=strategy.position_size*low
_drawdown_equity_percent=(_drawdown_actual_value*100/_deal_total_value)-100
else
_drawdown_actual_value=strategy.position_size*high
_drawdown_equity_percent=100-(_drawdown_actual_value*100/_deal_total_value)
is_deal_started()=>
_flag=false
ifIS_LONGandstrategy.position_size>0
_flag:=true
elseifnotIS_LONGandstrategy.position_size<0
_flag:=true
else
_flag:=false
//initarraywith0values
init_stats_array_safety_orders()=>
for_i=0tocfg_max_safety_orders
array.push(statsarray_safety_orders,0)
array.push(statsarray_safety_orders_timeout,0)
get_bot_startdeal_json()=>
_string="{\"message_type\":\"bot\",\"bot_id\":\""+cfg_bot_id+"\",\"email_token\":\""+cfg_email_token+"\",\"delay_seconds\":0,\"pair\":\""+tostring(syminfo.currency)+"_"+tostring(syminfo.basecurrency)+"\"}"

get_bot_stopdeal_json()=>
_string="{\"action\":\"close_at_market_price_all\",\"message_type\":\"bot\",\"bot_id\":\""+cfg_bot_id+"\",\"email_token\":\""+cfg_email_token+"\",\"delay_seconds\":0,\"pair\":\""+tostring(syminfo.currency)+"_"+tostring(syminfo.basecurrency)+"\"}"
get_month_string(month_number)=>
ifmonth_number==1
_string="Jan"
elseifmonth_number==2
_string="Feb"
elseifmonth_number==3
_string="Mar"
elseifmonth_number==4
_string="Apr"
elseifmonth_number==5
_string="May"
elseifmonth_number==6
_string="Jun"
elseifmonth_number==7
_string="Jul"
elseifmonth_number==8
_string="Aug"
elseifmonth_number==9
_string="Sep"
elseifmonth_number==10
_string="Oct"
elseifmonth_number==11
_string="Nov"
elseifmonth_number==12
_string="Dec"
time_to_date_string(timeinms)=>
iftimeinms>0
_string=tostring(dayofmonth(timeinms),"00/")+get_month_string(month(timeinms))+"/"+tostring(year(timeinms),"0000")+
""+tostring(hour(timeinms),"00:")+tostring(minute(timeinms),"00:")+tostring(second(timeinms),"00")
else
_string=""
get_bg_color_grey(row)=>
_bgcolor=(row%2==0)?#CACACA:#E5E5E5
get_bg_color_blue()=>
_bgcolor=#006bb3
get_bg_color_green()=>
_bgcolor=#A6E59B
get_bg_color_red()=>
_bgcolor=#E59B9B
get_bg_color_lightblue()=>
_bgcolor=#00BFFF
get_bg_color_orange()=>
_bgcolor=#FFA500
//statsforbuyandholdreturn
if(in_date_rangeandbh_calculation_started==false)
bh_start_price:=open
bh_start_time:=time
bh_calculation_started:=true
bh_end_price:=close
bh_end_time:=time_close
//updatestatsforbuyandholdaslongaswe'restillinsidedaterange
if(in_date_range)
bh_end_price:=close
bh_end_time:=time_close
//buyconditionforbaseorder
if(in_date_rangeanddeal_start_conditionandlast_performed_action==0)
//statsforthefirstdeal
iffirstdeal_started==false
firstdeal_started:=true
firstdeal_bar_index:=bar_index
firstdeal_start_price:=close
firstdeal_start_time:=time
init_stats_array_safety_orders()
stats_deals_started:=stats_deals_started+1
glb_dealstart_bar_index:=bar_index
glb_dealstart_bar_time:=time
//howmanycoins
glb_base_order_qty:=cfg_base_order_size_usd/close
//Thisvaluewillbeoverwrittenwiththeactualmarketprice
glb_base_order_price:=close
ifvalid_stop_loss()
glb_stop_loss_price:=stop_loss_price()
//enterwithmarketorder
//ifusinglimitorderandopenofnextcandleisdifferentthancloseofcurrentcandle
//thedealmightnotstart


_alert_human="D"+tostring(stats_deals_started)+"-BO("+
tostring(syminfo.basecurrency)+"-"+tostring(syminfo.currency)+
(cfg_strategy_type=="long"?"LONG":"SHORT")+")|"+
tostring(glb_base_order_qty*glb_base_order_price)+""+tostring(syminfo.currency)

ifcfg_enable_bot_controlandcfg_exec_deal_start
_alert_json=get_bot_startdeal_json()
strategy.entry(id="D"+tostring(stats_deals_started)+"-BO",long=IS_LONG,qty=glb_base_order_qty,alert_message=_alert_json)
alert(_alert_human,alert.freq_once_per_bar_close)
else
strategy.entry(id="D"+tostring(stats_deals_started)+"-BO",long=IS_LONG,qty=glb_base_order_qty,alert_message=_alert_human)
alert(_alert_human,alert.freq_once_per_bar_close)
last_performed_action:=1
//ifweareinadeal
ifis_deal_started()
glb_take_profit_price:=take_profit_price()
ifis_planb_timeout()andcfg_planb_action!="none"
glb_planb_timeout_price:=planb_timeout_price()


//calculateSLaswell
ifvalid_stop_loss()
glb_stop_loss_price:=stop_loss_price()
//savethesevariablesforpushingstatsafterthedealisfinished
glb_current_deal_position_size:=strategy.position_size
glb_current_deal_avg_price:=strategy.position_avg_price
//statsformaxdrawndown
ifstrategy.openprofit<stats_max_drawdown
stats_max_drawdown:=strategy.openprofit
stats_max_drawdown_equity_percent:=get_current_drawdown_equity()
//approx
stats_max_drawdown_time:=time_close
//biggestdropvsbaseorderprice
_current_dev_vs_bo_price=get_current_dev_vs_bo_price()
if_current_dev_vs_bo_price<stats_biggest_dev
stats_biggest_dev:=_current_dev_vs_bo_price
//approx
stats_biggest_dev_time:=time_close
//placethefirstsafetyorder(SO)
if(strategy.opentrades==1)and(last_performed_action==1)and(cfg_max_safety_orders>0)
//label.new(bar_index,low-(low*8/100),text="PBO:"+tostring(strategy.position_size)+"@"+tostring(strategy.position_avg_price),
//yloc=yloc.price,size=size.small,style=label.style_none,textcolor=theme_text_color)
//gettherealvolumeandpriceforexecutedBO
glb_current_deal_prev_position_size:=strategy.position_size
glb_base_order_price:=strategy.position_avg_price
glb_total_volume+=strategy.position_size*strategy.position_avg_price
count_placed_safety_orders:=count_placed_safety_orders+1
glb_next_safety_order_price:=next_so_price(count_placed_safety_orders,glb_base_order_price)
glb_next_safety_order_qty:=next_so_qty(count_placed_safety_orders,glb_base_order_price)
//placesafetyorderaslimitorder

//----------------------------
//Iguessthereisnoreasontosendhumanreadeablealertstothebot,sothissection
//isrefactored.Feelfreetore-usethisifyourareinterestedinsendingnotificationsat
//thesametimethestrategyordertriggers
//----------------------------

//_alert="D"+tostring(stats_deals_started)+"-SO"+tostring(count_placed_safety_orders)+"("+
//tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
//(cfg_strategy_type=="long"?"LONG":"SHORT")+")|"+
//tostring(glb_next_safety_order_qty*glb_next_safety_order_price)+""+tostring(syminfo.currency)
//strategy.entry(id="D"+tostring(stats_deals_started)+"-SO"+tostring(count_placed_safety_orders),
//long=IS_LONG,qty=glb_next_safety_order_qty,limit=glb_next_safety_order_price,alert_message=_alert)
strategy.entry(id="D"+tostring(stats_deals_started)+"-SO"+tostring(count_placed_safety_orders),
long=IS_LONG,qty=glb_next_safety_order_qty,limit=glb_next_safety_order_price)
//markthatasafetyorderwasplaced
last_performed_action:=2
//debuglabels
//label.new(bar_index,low-(low*7/100),text="BO\n"+
//tostring(strategy.position_size)+"@"+tostring(strategy.position_avg_price),
//yloc=yloc.price,size=size.small,style=label.style_none,textcolor=theme_text_color)
//label.new(bar_index,low-(low*10/100),text="SO"+tostring(count_placed_safety_orders)+"\n"+
//tostring(glb_next_safety_order_qty)+"\n"+tostring(glb_next_safety_order_price),
//yloc=yloc.price,size=size.small,style=label.style_none,textcolor=theme_text_color)
//label.new(bar_index,low-(low*7/100),text="AVG\n"+tostring(strategy.position_avg_price),
//yloc=yloc.price,size=size.small,style=label.style_none,textcolor=theme_text_color)
//label.new(bar_index,low-(low*8/100),text="OT\n"+tostring(strategy.opentrades),
//yloc=yloc.price,size=size.small,style=label.style_none,textcolor=theme_text_color)
//label.new(bar_index,low-(low*7/100),text="PS\n"+tostring(strategy.position_size),
//yloc=yloc.price,size=size.small,style=label.style_none,textcolor=theme_text_color)
//label.new(bar_index,low-(low*10/100),text="CNT\n"+tostring(count_placed_safety_orders),
//yloc=yloc.price,size=size.small,style=label.style_none,textcolor=theme_text_color)
//ifthereare0safetyordersconfiguredsavevaluesforstatistics
elseif(strategy.opentrades==1)and(last_performed_action==1)and(cfg_max_safety_orders==0)
//gettheBOactualexecutedvolumeandpriceandmark
//lastperformedactiontoavoidfurtherexecutionofthiscode
last_performed_action:=2
glb_current_deal_prev_position_size:=strategy.position_size
glb_base_order_price:=strategy.position_avg_price
glb_total_volume+=strategy.position_size*strategy.position_avg_price
//aftereachSOisfilledweplacenextSOorder
if(strategy.opentrades>count_placed_safety_orders)and(last_performed_action==2)
and(count_placed_safety_orders<cfg_max_safety_orders)
//label.new(bar_index,low-(low*8/100),text="TP@"+tostring(glb_take_profit_price),
//yloc=yloc.price,size=size.small,style=label.style_none,textcolor=theme_text_color)
//label.new(bar_index,low-(low*8/100),
//text="PSO"+tostring(count_placed_safety_orders)+":"+
//tostring(strategy.position_size-glb_current_deal_prev_position_size)+"@"+tostring(glb_next_safety_order_price),
//yloc=yloc.price,size=size.small,style=label.style_none,textcolor=theme_text_color)
//delayedalertonthenextcandle,aboutpreviousSOexecution
_alert_human="D"+tostring(stats_deals_started)+"-SO"+tostring(count_placed_safety_orders)+"[delayed]("+
tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
(cfg_strategy_type=="long"?"LONG":"SHORT")+")|"+
tostring(glb_next_safety_order_qty*glb_next_safety_order_price)+""+tostring(syminfo.currency)
alert(_alert_human,alert.freq_once_per_bar_close)
count_executed_safety_orders:=count_executed_safety_orders+1
count_placed_safety_orders:=count_placed_safety_orders+1
//calculatefrompreviousexecutedsafetyorder
glb_total_volume+=(strategy.position_size-glb_current_deal_prev_position_size)*glb_next_safety_order_price
//nowwecancalculatenextvalues
glb_current_deal_prev_position_size:=strategy.position_size
glb_next_safety_order_price:=next_so_price(count_placed_safety_orders,glb_base_order_price)
glb_next_safety_order_qty:=next_so_qty(count_placed_safety_orders,glb_base_order_price)

//placenextSOaslimit

//----------------------------
//Iguessthereisnoreasontosendhumanreadeablealertstothebot,sothissection
//isrefactored.Feelfreetore-usethisifyourareinterestedinsendingnotificationsat
//thesametimethestrategyordertriggers
//----------------------------

//_alert="D"+tostring(stats_deals_started)+"-SO"+tostring(count_placed_safety_orders)+"("+
//tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
//(cfg_strategy_type=="long"?"LONG":"SHORT")+")|"+
//tostring(glb_next_safety_order_qty*glb_next_safety_order_price)+""+tostring(syminfo.currency)
//strategy.entry(id="D"+tostring(stats_deals_started)+"-SO"+tostring(count_placed_safety_orders),
//long=IS_LONG,qty=glb_next_safety_order_qty,limit=glb_next_safety_order_price,alert_message=_alert)

strategy.entry(id="D"+tostring(stats_deals_started)+"-SO"+tostring(count_placed_safety_orders),
long=IS_LONG,qty=glb_next_safety_order_qty,limit=glb_next_safety_order_price)

//markthatasafetyorderwasplaced
last_performed_action:=2
//ifweexecutedthemaxsafetyorder,wewillnotplaceanother,butupdatestats
elseif(strategy.opentrades>count_placed_safety_orders)and(last_performed_action==2)
and(count_placed_safety_orders==cfg_max_safety_orders)
and(count_executed_safety_orders<count_placed_safety_orders)

//delayedalertaboutpreviousSOexecution
_alert_human="D"+tostring(stats_deals_started)+"-SO"+tostring(count_placed_safety_orders)+"[delayed]("+
tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
(cfg_strategy_type=="long"?"LONG":"SHORT")+")|"+
tostring(glb_next_safety_order_qty*glb_next_safety_order_price)+""+tostring(syminfo.currency)
alert(_alert_human,alert.freq_once_per_bar_close)

count_executed_safety_orders:=count_executed_safety_orders+1
glb_total_volume+=(strategy.position_size-glb_current_deal_prev_position_size)
*glb_next_safety_order_price
glb_current_deal_prev_position_size:=strategy.position_size
glb_next_safety_order_price:=na
ifvalid_stop_loss()
ifcfg_enable_bot_controlandcfg_exec_stop_loss
_alert_json=get_bot_stopdeal_json()
strategy.exit(id="D"+tostring(stats_deals_started)+"-SL",
stop=glb_stop_loss_price,when=is_deal_started(),alert_message=_alert_json)
else
//----------------------------
//Iguessthereisnoreasontosendhumanreadeablealertstothebot,sothissection
//isrefactored.Feelfreetore-usethisifyourareinterestedinsendingnotificationsat
//thesametimethestrategyordertriggers
//----------------------------

//_alert_human="D"+tostring(stats_deals_started)+"-SL("+
//tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
//(cfg_strategy_type=="long"?"LONG":"SHORT")+")"
//strategy.exit(id="D"+tostring(stats_deals_started)+"-SL",
//stop=glb_stop_loss_price,when=is_deal_started(),alert_message=_alert_human)

strategy.exit(id="D"+tostring(stats_deals_started)+"-SL",
stop=glb_stop_loss_price,when=is_deal_started())
ifcfg_enable_bot_controlandcfg_exec_take_profit
_alert_json=get_bot_stopdeal_json()
strategy.order(id="D"+tostring(stats_deals_started)+"-TP",limit=glb_take_profit_price,
long=(IS_LONG?false:true),qty=abs(strategy.position_size),when=is_deal_started(),alert_message=_alert_json)
else
//----------------------------
//Iguessthereisnoreasontosendhumanreadeablealertstothebot,sothissection
//isrefactored.Feelfreetore-usethisifyourareinterestedinsendingnotificationsat
//thesametimethestrategyordertriggers
//----------------------------

//_alert_human="D"+tostring(stats_deals_started)+"-TP("+
//tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
//(cfg_strategy_type=="long"?"LONG":"SHORT")+")"
//strategy.order(id="D"+tostring(stats_deals_started)+"-TP",limit=glb_take_profit_price,
//long=(IS_LONG?false:true),qty=abs(strategy.position_size),when=is_deal_started(),alert_message=_alert_human)

strategy.order(id="D"+tostring(stats_deals_started)+"-TP",limit=glb_take_profit_price,
long=(IS_LONG?false:true),qty=abs(strategy.position_size),when=is_deal_started())
ifis_planb_timeout()andcfg_planb_action=="closedeal"
//canceltakeprofitorder
strategy.cancel(id="D"+tostring(stats_deals_started)+"-TP")
ifcfg_enable_bot_controlandcfg_exec_planb_timeout
_alert_json=get_bot_stopdeal_json()
strategy.order(id="D"+tostring(stats_deals_started)+"-TIMEOUT",limit=glb_planb_timeout_price,
long=(IS_LONG?false:true),qty=abs(strategy.position_size),when=is_deal_started(),alert_message=_alert_json)
else
//----------------------------
//Iguessthereisnoreasontosendhumanreadeablealertstothebot,sothissection
//isrefactored.Feelfreetore-usethisifyourareinterestedinsendingnotificationsat
//thesametimethestrategyordertriggers
//----------------------------

//_alert_human="D"+tostring(stats_deals_started)+"-TIMEOUT("+
//tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
//(cfg_strategy_type=="long"?"LONG":"SHORT")+")"
//strategy.order(id="D"+tostring(stats_deals_started)+"-TIMEOUT",limit=glb_planb_timeout_price,
//long=(IS_LONG?false:true),qty=abs(strategy.position_size),when=is_deal_started(),alert_message=_alert_human)

strategy.order(id="D"+tostring(stats_deals_started)+"-TIMEOUT",limit=glb_planb_timeout_price,
long=(IS_LONG?false:true),qty=abs(strategy.position_size),when=is_deal_started())
//ifweexitedonthiscandle(eitherTPorSL),wewanttocancelremainingordersfromthistrade
condition_take_profit=is_condition_take_profit()
condition_stop_loss=is_condition_stop_loss()
condition_planb_timeout=is_condition_planb_price()andis_planb_timeout()andcfg_planb_action=="closedeal"
condition_to_cancel_open_orders=condition_take_profitorcondition_stop_lossorcondition_planb_timeout
//resetvariablesfornexttradeandpushstats
ifcondition_to_cancel_open_orders
//commonstatsforallcases
_current_days_in_deal=get_days(glb_dealstart_bar_time,time)
array.push(statsarray_no_of_bars,bar_index-glb_dealstart_bar_index)
array.push(statsarray_no_of_days,_current_days_in_deal)
stats_deals_finished:=stats_deals_finished+1
ifstats_max_days_in_deal<=_current_days_in_deal
stats_max_days_in_deal:=_current_days_in_deal
//approx
stats_max_days_in_deal_start_time:=glb_dealstart_bar_time
stats_max_days_in_deal_close_time:=time
//extractingPNL
glb_current_deal_pnl:=strategy.netprofit-glb_strategy_prev_netprofit
glb_strategy_prev_netprofit:=strategy.netprofit
//statisticsspecifictoeachexitcase
ifcondition_stop_loss
stats_deals_stop_loss_finished:=stats_deals_stop_loss_finished+1
glb_current_deal_close_value:=glb_current_deal_position_size*glb_stop_loss_price
glb_total_volume+=glb_current_deal_close_value
array.push(statsarray_losing_deals_pnl,glb_current_deal_pnl)
ifcfg_show_pnl_labels
label.new(bar_index,glb_stop_loss_price,
text=tostring(round(glb_current_deal_pnl,cfg_decimals))+
""+tostring(syminfo.currency)+"\n"+get_timespan_string(glb_dealstart_bar_time,time),
yloc=yloc.price,size=size.normal,style=label.style_labeldown,textcolor=color.black,color=get_bg_color_red())
//delayedalertaboutdealclosebystoploss
_alert_human="D"+tostring(stats_deals_started)+"-SL[delayed]("+
tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
(cfg_strategy_type=="long"?"LONG":"SHORT")+")|"+tostring(round(glb_current_deal_pnl,cfg_decimals))+""
+tostring(syminfo.currency)+"|"+get_timespan_string(glb_dealstart_bar_time,time)
alert(_alert_human,alert.freq_once_per_bar_close)
elseifcondition_planb_timeout
stats_deals_timeout_finished:=stats_deals_timeout_finished+1
//executesonopenprice
glb_current_deal_close_value:=glb_current_deal_position_size*open
glb_total_volume+=glb_current_deal_close_value
array.push(statsarray_timeout_deals_pnl,glb_current_deal_pnl)
ifglb_current_deal_pnl>=0
array.push(statsarray_winning_deals_pnl,glb_current_deal_pnl)
else
array.push(statsarray_losing_deals_pnl,glb_current_deal_pnl)
//increaseSOarrayaswellbutalsoaseparatethatholdstimeoutdealscount
array.set(statsarray_safety_orders,count_executed_safety_orders,array.get(statsarray_safety_orders,count_executed_safety_orders)+1)
array.set(statsarray_safety_orders_timeout,count_executed_safety_orders,array.get(statsarray_safety_orders_timeout,count_executed_safety_orders)+1)
ifcfg_show_pnl_labels
label.new(bar_index,glb_planb_timeout_price,
text=""+tostring(round(glb_current_deal_pnl,cfg_decimals))+
""+tostring(syminfo.currency)+"\n"+get_timespan_string(glb_dealstart_bar_time,time),
yloc=yloc.price,size=size.normal,style=label.style_labeldown,textcolor=color.black,color=get_bg_color_lightblue())
//delayedalertaboutdealclosebytimeout
_alert_human="D"+tostring(stats_deals_started)+"-TIMEOUT[delayed]("+
tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
(cfg_strategy_type=="long"?"LONG":"SHORT")+")|"+tostring(round(glb_current_deal_pnl,cfg_decimals))+""
+tostring(syminfo.currency)+"|"+get_timespan_string(glb_dealstart_bar_time,time)
alert(_alert_human,alert.freq_once_per_bar_close)
elseifcondition_take_profit
//weconsiderthatdealclosedwithanySO,ifnotclosedwithSL
array.set(statsarray_safety_orders,count_executed_safety_orders,array.get(statsarray_safety_orders,count_executed_safety_orders)+1)
stats_deals_take_profit_finished:=stats_deals_take_profit_finished+1
glb_current_deal_close_value:=glb_current_deal_position_size*glb_take_profit_price
glb_total_volume+=glb_current_deal_close_value
array.push(statsarray_winning_deals_pnl,glb_current_deal_pnl)
ifcfg_show_pnl_labels
label.new(bar_index,glb_take_profit_price,
text=""+tostring(round(glb_current_deal_pnl,cfg_decimals))+
""+tostring(syminfo.currency)+"\n"+get_timespan_string(glb_dealstart_bar_time,time),
yloc=yloc.price,size=size.normal,style=label.style_labelup,textcolor=color.black,color=get_bg_color_green())
//delayedalertaboutdealclosebytakeprofit
_alert_human="D"+tostring(stats_deals_started)+"-TP[delayed]("+
tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
(cfg_strategy_type=="long"?"LONG":"SHORT")+")|"+tostring(round(glb_current_deal_pnl,cfg_decimals))+""
+tostring(syminfo.currency)+"|"+get_timespan_string(glb_dealstart_bar_time,time)
alert(_alert_human,alert.freq_once_per_bar_close)
strategy.cancel_all(when=condition_to_cancel_open_orders)
//RESETGLOBALSAFTERDEALCOMPLETION
lastdeal_close_bar_index:=bar_index
//approximate
lastdeal_close_time:=time
glb_take_profit_price:=na
glb_planb_timeout_price:=na
glb_stop_loss_price:=na
glb_base_order_price:=na
glb_base_order_qty:=na
glb_next_safety_order_price:=na
glb_next_safety_order_qty:=na
glb_current_deal_position_size:=na
glb_current_deal_prev_position_size:=na
glb_current_deal_avg_price:=na
glb_current_deal_close_value:=na
glb_current_deal_pnl:=0
glb_dealstart_bar_index:=na
glb_dealstart_bar_time:=na
last_performed_action:=0
count_placed_safety_orders:=0
count_executed_safety_orders:=0
_color_avg_price=theme_text_color
_color_take_profit=color.green
ifis_planb_timeout()andcfg_planb_action!="none"
_color_avg_price:=get_bg_color_lightblue()

ifis_planb_timeout()andcfg_planb_action=="closedeal"
_color_take_profit:=color.new(color.green,100)

p1=plot(glb_take_profit_price,color=_color_take_profit,style=plot.style_circles,title="TakeProfit")
p2=plot(strategy.position_avg_price,color=theme_text_color,style=plot.style_circles,title="Dealavgprice")
p3=plot(glb_next_safety_order_price,color=color.orange,style=plot.style_circles,title="Safetyorder")
p4=plot(glb_stop_loss_price,color=color.red,style=plot.style_circles,title="Stoploss")
p5=plot(glb_planb_timeout_price,color=get_bg_color_lightblue(),style=plot.style_circles,title="PLAN-B")
fill(p1,p2,color=_color_take_profit,title="Filltakeprofit")
fill(p2,p3,color=color.orange,title="Fillsafetyorder")
fill(p3,p4,color=color.red,title="Fillstoploss")
_col=(cfg_max_safety_orders==0?color.new(color.red,90):color.new(color.red,100))
fill(p2,p4,color=_col,title="Fillstoploss")
fill(p2,p5,color=get_bg_color_lightblue(),title="FillPLAN-B")
//TABLES
ifbarstate.islastconfirmedhistory
glb_required_capital:=get_required_capital()
//ifwearestillinadeal,updatesomestatstocurrentbar
_deal_in_progress=stats_deals_finished<stats_deals_started
if_deal_in_progress
lastdeal_close_bar_index:=bar_index
//approximate
lastdeal_close_time:=time
array.push(statsarray_no_of_bars,bar_index-glb_dealstart_bar_index)
array.push(statsarray_no_of_days,get_days(glb_dealstart_bar_time,time_close))
ifstats_max_days_in_deal<=get_days(glb_dealstart_bar_time,time_close)
stats_max_days_in_deal:=get_days(glb_dealstart_bar_time,time_close)
stats_max_days_in_deal_start_time:=glb_dealstart_bar_time
stats_max_days_in_deal_close_time:=time_close
//----------------------------------------------------------------
//datavalidationandatablewithwarnings
string_text_warnings=""
ifstats_deals_started==0
_text_warnings+="-Nodealstarted\n"
ifstats_deals_finished==0
_text_warnings+="-Nodealfinished\n"
if(cfg_enable_stop_lossand(valid_stop_loss()==false))
_text_warnings+="-Stoplossislessthanlastsafetyorder(shouldbemorethan"+
tostring(round(stepped_deviation(cfg_max_safety_orders),2))+"%"+")\n"
ifstepped_deviation(cfg_max_safety_orders)>100
_text_warnings+="-Covereddeviationviasafetyordersisover100%\n"
if_text_warnings!=""
tablewarnings=table.new(position.bottom_center,columns=1,rows=2,
frame_width=1,frame_color=color.red,border_width=1,border_color=color.red,bgcolor=color.red)
table.cell(warnings,0,0,"WARNINGS!\n(Fixthem,otherwisethestatsareinnacurate)",
text_color=color.white,text_halign=text.align_center)
table.cell(warnings,0,1,_text_warnings,
text_color=color.white,text_halign=text.align_left)
//----------------------------------------------------------------
//----------------------------------------------------------------
//atablewithbuyingsteps,volumes,pricessimilarto3commas
//setcustomvaluesforboentryprice
ifcfg_show_step_table
_steps_bo_size=cfg_base_order_size_usd/cfg_steps_bo_price
tablesteps_amount=table.new(position.bottom_left,columns=8,rows=int(cfg_max_safety_orders)+4,
frame_width=1,frame_color=color.black,border_width=1,border_color=color.black,bgcolor=color.green)
table.cell(steps_amount,0,0,"Order\nno",text_color=color.white,text_size=size.small)
table.cell(steps_amount,1,0,"Deviation\n(%)",text_color=color.white,text_size=size.small)
table.cell(steps_amount,2,0,"Size\n("+tostring(syminfo.basecurrency)+")",text_color=color.white,text_size=size.small)
table.cell(steps_amount,3,0,"Volume\n("+tostring(syminfo.currency)+")",text_color=color.white,text_size=size.small)
table.cell(steps_amount,4,0,"Price\n("+tostring(syminfo.currency)+")",text_color=color.white,text_size=size.small)
table.cell(steps_amount,5,0,"Avgprice\n("+tostring(syminfo.currency)+")",text_color=color.white,text_size=size.small)
table.cell(steps_amount,6,0,"Totalsize\n("+tostring(syminfo.basecurrency)+")",text_color=color.white,text_size=size.small)
table.cell(steps_amount,7,0,"TotalVol\n("+tostring(syminfo.currency)+")",text_color=color.white,text_size=size.small)
float_steps_total_size=_steps_bo_size
float_steps_total_volume=cfg_steps_bo_price*_steps_bo_size
//baseorder
table.cell(steps_amount,0,1,"BO",text_color=color.white,text_size=size.small)
table.cell(steps_amount,1,1,"0",text_color=color.white,text_size=size.small)
table.cell(steps_amount,2,1,tostring(_steps_bo_size),text_color=color.white,text_size=size.small)
table.cell(steps_amount,3,1,tostring(cfg_steps_bo_price*_steps_bo_size),text_color=color.white,text_size=size.small)
table.cell(steps_amount,4,1,tostring(cfg_steps_bo_price),text_color=color.white,text_size=size.small)
table.cell(steps_amount,5,1,tostring(_steps_total_volume/_steps_total_size),text_color=color.white,text_size=size.small)
table.cell(steps_amount,6,1,tostring(_steps_total_size),text_color=color.white,text_size=size.small)
table.cell(steps_amount,7,1,tostring(_steps_total_volume),text_color=color.white,text_size=size.small)
float_steps_next_safety_order_price=0
float_steps_next_safety_order_qty=0
ifcfg_max_safety_orders>0
for_i=1tocfg_max_safety_orders
_steps_next_safety_order_price:=next_so_price(_i,cfg_steps_bo_price)
_steps_next_safety_order_qty:=next_so_qty(_i,cfg_steps_bo_price)
_steps_total_size+=_steps_next_safety_order_qty
_steps_total_volume+=_steps_next_safety_order_qty*_steps_next_safety_order_price
table.cell(steps_amount,0,(_i+2),tostring(_i),text_color=color.white,text_size=size.small)
table.cell(steps_amount,1,(_i+2),tostring(stepped_deviation(_i)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,2,(_i+2),tostring(_steps_next_safety_order_qty),text_color=color.white,text_size=size.small)
table.cell(steps_amount,3,(_i+2),tostring(_steps_next_safety_order_qty*_steps_next_safety_order_price),
text_color=color.white,text_size=size.small)
table.cell(steps_amount,4,(_i+2),tostring(_steps_next_safety_order_price),text_color=color.white,text_size=size.small)
table.cell(steps_amount,5,(_i+2),tostring(_steps_total_volume/_steps_total_size),text_color=color.white,text_size=size.small)
table.cell(steps_amount,6,(_i+2),tostring(_steps_total_size),text_color=color.white,text_size=size.small)
table.cell(steps_amount,7,(_i+2),tostring(_steps_total_volume),text_color=color.white,text_size=size.small)
//----------------------------------------------------------------
//----------------------------------------------------------------
//atablewithallkindofstatisticsaboutstrategyresults
ifcfg_show_stats_table
introwsforstats=array.size(statsarray_safety_orders)+25
tablesostats=table.new(position.top_right,columns=2,rows=rowsforstats,
frame_width=1,frame_color=color.black)
_row=0
table.cell(sostats,column=0,row=_row,
text="ZendogDCABacktester"+tostring(syminfo.basecurrency)+"/"+tostring(syminfo.currency),
text_halign=text.align_left,text_size=size.small,text_color=color.white,bgcolor=get_bg_color_blue())
table.cell(sostats,column=1,row=_row,text="",text_size=size.small,text_color=color.white,bgcolor=get_bg_color_blue())
_row+=1
table.cell(sostats,column=0,row=_row,text="Status:",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
if_deal_in_progress
table.cell(sostats,column=1,row=_row,text="Dealinprogress",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_red())
elseifstats_deals_started==0andstats_deals_finished==0
table.cell(sostats,column=1,row=_row,text="Nodeals",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_red())
else
table.cell(sostats,column=1,row=_row,text="Alldealsclosed",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_green())
_row+=1
table.cell(sostats,column=0,row=_row,text="Opendeals:",text_halign=text.align_left,
text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
ifstats_deals_started-stats_deals_finished==0
table.cell(sostats,column=1,row=_row,text="0",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_green())
else
_current_deal_total_value=strategy.position_size*strategy.position_avg_price
_current_deal_actual_value=strategy.position_size*close
float_current_deal_equity_percent=0
ifIS_LONG
_current_deal_equity_percent:=(_current_deal_actual_value*100/_current_deal_total_value)-100
else
_current_deal_equity_percent:=100-(_current_deal_actual_value*100/_current_deal_total_value)
_text0=tostring(stats_deals_started-stats_deals_finished)+"deal\n"
_text0:=_text0+tostring(round(strategy.openprofit,cfg_decimals))+""+tostring(syminfo.currency)
_text0:=_text0+"("+tostring(round(_current_deal_equity_percent,2))+"%)\n"
_text0:=_text0+tostring(get_timespan_string(glb_dealstart_bar_time,time_close))+
",currentlyatSO"+tostring(count_placed_safety_orders)+"\n"
_text0:=_text0+"(start:"+tostring(time_to_date_string(glb_dealstart_bar_time))+")"
table.cell(sostats,column=1,row=_row,text=_text0,
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_red())
_row+=1
table.cell(sostats,column=0,row=_row,text="Finisheddeals:",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=tostring(stats_deals_finished),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
table.cell(sostats,column=0,row=_row,text="Winningdeals:",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
ifstats_deals_take_profit_finished==0
table.cell(sostats,column=1,row=_row,text=tostring(array.size(statsarray_winning_deals_pnl)),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
else
_text5=""
_text5:=_text5+tostring(stats_deals_take_profit_finished)
_text5:=_text5+"("+tostring(round(array.avg(statsarray_winning_deals_pnl),cfg_decimals))
_text5:=_text5+""+tostring(syminfo.currency)+"onavg)"
table.cell(sostats,column=1,row=_row,text=_text5,
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_green())
_row+=1
table.cell(sostats,column=0,row=_row,text="Losingdeals:",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
ifarray.size(statsarray_losing_deals_pnl)==0
table.cell(sostats,column=1,row=_row,text=tostring(array.size(statsarray_losing_deals_pnl)),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_green())
else
_text6=""
_text6:=_text6+tostring(array.size(statsarray_losing_deals_pnl))
_text6:=_text6+"("+tostring(round(array.avg(statsarray_losing_deals_pnl),cfg_decimals))
_text6:=_text6+""+tostring(syminfo.currency)+"onavg)"
table.cell(sostats,column=1,row=_row,text=_text6,
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_red())
_row+=1
table.cell(sostats,column=0,row=_row,text="Timeoutdeals:",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
ifstats_deals_timeout_finished==0
table.cell(sostats,column=1,row=_row,text=tostring(stats_deals_timeout_finished),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_green())
else
_text6=""
_text6:=_text6+tostring(stats_deals_timeout_finished)
_text6:=_text6+"("+tostring(round(array.avg(statsarray_timeout_deals_pnl),cfg_decimals))
_text6:=_text6+""+tostring(syminfo.currency)+"onavg)"
table.cell(sostats,column=1,row=_row,text=_text6,
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_lightblue())
_row+=1
table.cell(sostats,column=0,row=_row,
text="Totaltime(Max|Avgtimeindeal):",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_text4=""+tostring(get_timespan_string(bh_start_time,bh_end_time))+"("
_text4:=_text4+""+get_timestring_from_days(array.max(statsarray_no_of_days))+"|"
_text4:=_text4+""+get_timestring_from_days(array.avg(statsarray_no_of_days))+")"
table.cell(sostats,column=1,row=_row,text=_text4,
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
table.cell(sostats,column=0,row=_row,
text="Totalbacktest:\n"+tostring(time_to_date_string(bh_start_time))+"\n"+tostring(time_to_date_string(bh_end_time)),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,
text="Maxdaysindeal:\n"+tostring(time_to_date_string(stats_max_days_in_deal_start_time))+"\n"+
tostring(time_to_date_string(stats_max_days_in_deal_close_time)),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
table.cell(sostats,column=0,row=_row,text="Requiredcapital:",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=tostring(glb_required_capital)+""+tostring(syminfo.currency),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
table.cell(sostats,column=0,row=_row,text="Profit:\n(aftercommision)",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_text1=tostring(round(get_final_pnl_new(),cfg_decimals))+""+tostring(syminfo.currency)
_text1:=_text1+"("+tostring(round(get_final_pnl_prct_new(),2))+"%)\n"
ifget_days(bh_start_time,bh_end_time)>=1
_text1:=_text1+tostring(round(get_final_pnl_prct_new()/get_days(bh_start_time,bh_end_time),2))+"%/day"
else
_text1:=_text1+tostring(round(get_final_pnl_prct_new(),2))+"%/day"
table.cell(sostats,column=1,row=_row,text=_text1,
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
//ifdaterangeislimitedcalculatebetweenstartandenddate
_bh_equity=((glb_required_capital/bh_start_price)*bh_end_price)-glb_required_capital
_bh_commision=get_commission_for_volume(glb_required_capital+((glb_required_capital/bh_start_price)*bh_end_price))
_bh_equity:=_bh_equity-_bh_commision
_bh_prct_total=round(_bh_equity*100/glb_required_capital,2)
table.cell(sostats,column=0,row=_row,text="Buy&holdreturn:\n(aftercommision)",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_text2=tostring(round(_bh_equity,cfg_decimals))+""+tostring(syminfo.currency)
_text2:=_text2+"("+tostring(_bh_prct_total)+"%)\n"
ifget_days(bh_start_time,bh_end_time)>=1
_text2:=_text2+tostring(round(_bh_prct_total/get_days(bh_start_time,bh_end_time),2))+"%/day"
else
_text2:=_text2+tostring(round(_bh_prct_total,2))+"%/day"
table.cell(sostats,column=1,row=_row,text=_text2,
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
table.cell(sostats,column=0,row=_row,text="Covereddeviation:",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=tostring(round(stepped_deviation(cfg_max_safety_orders),2))+"%",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
string_bef=valid_stop_loss()?"beforeSL":""
table.cell(sostats,column=0,row=_row,text="Maxdeviation:\n(Dealstartpricevsworstcandle"+_bef+")",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=tostring(round(stats_biggest_dev,2))+"%\n"+
"("+time_to_date_string(stats_biggest_dev_time)+")",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
table.cell(sostats,column=0,row=_row,text="Maxdrawdownfrombreakeven:\n(Avgpricevsworstcandle"+_bef+")",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=tostring(round(stats_max_drawdown,cfg_decimals))+""+tostring(syminfo.currency)+
"("+tostring(round(stats_max_drawdown_equity_percent,2))+"%)\n"+
"("+time_to_date_string(stats_max_drawdown_time)+")",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
table.cell(sostats,column=0,row=_row,text="Max#barsindeal:",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=tostring(array.max(statsarray_no_of_bars)),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
table.cell(sostats,column=0,row=_row,text="Avg#barsindeal:",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=tostring(round(array.avg(statsarray_no_of_bars),2)),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
table.cell(sostats,column=0,row=_row,text="Totalvolume:",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=tostring(round(glb_total_volume,cfg_decimals))+""+tostring(syminfo.currency),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
table.cell(sostats,column=0,row=_row,text="Commision:",
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=tostring(round(get_commission_for_volume(glb_total_volume),cfg_decimals))+""+
tostring(syminfo.currency),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row+=1
ifarray.size(statsarray_safety_orders)>0
table.cell(sostats,column=0,row=_row,text="Closestatsfor"+tostring(stats_deals_finished)+"deals",
text_color=color.white,text_size=size.small,bgcolor=get_bg_color_blue(),text_halign=text.align_left)
table.cell(sostats,column=1,row=_row,text="Number(%)/Exitwithtimeout",text_color=color.white,text_size=size.small,bgcolor=get_bg_color_blue())
_row+=1
_saved_row=_row
_row+=2
_max_safety_orders=0
float_avg_safety_orders=0
for_i=0toarray.size(statsarray_safety_orders)-1
string_closed_text=""
if_i==0
_closed_text:="BO("+tostring(round(stepped_deviation(_i),2))+"%)"
else
_closed_text:="SO"+tostring(_i)+"("+tostring(round(stepped_deviation(_i),2))+"%)"
_cnt=array.get(statsarray_safety_orders,_i)
if_cnt>0and_i>_max_safety_orders
_max_safety_orders:=_i
_avg_safety_orders+=_cnt*_i
table.cell(sostats,column=0,row=(_row+_i),text="Closedwith"+_closed_text,text_halign=text.align_left,
text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row+_i))
table.cell(sostats,column=1,row=(_row+_i),
text=tostring(_cnt)+"("+tostring(round(_cnt*100/stats_deals_finished,2))+"%)/"+tostring(array.get(statsarray_safety_orders_timeout,_i)),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row+_i))
_avg_safety_orders:=round(_avg_safety_orders/array.sum(statsarray_safety_orders),1)
table.cell(sostats,column=0,row=_saved_row,text="MaxSOused:",text_halign=text.align_left,
text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_saved_row))
table.cell(sostats,column=1,row=_saved_row,text=tostring(_max_safety_orders),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_saved_row))
table.cell(sostats,column=0,row=_saved_row+1,text="AvgSOused:",text_halign=text.align_left,
text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_saved_row+1))
table.cell(sostats,column=1,row=_saved_row+1,text=tostring(_avg_safety_orders),
text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_saved_row+1))
ifvalid_stop_loss()
_row+=array.size(statsarray_safety_orders)
table.cell(sostats,column=0,row=_row,text="ClosedwithStopLoss("+tostring(cfg_stop_loss_perc)+"%)",text_halign=text.align_left,
text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,
text=tostring(stats_deals_stop_loss_finished)+"("+tostring(round(stats_deals_stop_loss_finished*100/stats_deals_finished,2))+"%)",
text_halign=text.align_left,text_color=color.black,text_size=size.small,
bgcolor=(stats_deals_stop_loss_finished>0?get_bg_color_red():get_bg_color_green()))
//----------------------------------------------------------------
//----------------------------------------------------------------
ifcfg_show_settings_table
tablesettings=table.new(position.bottom_left,columns=1,rows=2,
frame_width=1,frame_color=color.black)
_row=0
table.cell(settings,column=0,row=0,
text="DCASettings",
text_halign=text.align_left,text_size=size.small,text_color=color.white,bgcolor=get_bg_color_blue())
_text="Type:"+tostring(cfg_strategy_type)+";"
_text+="Commision:"+tostring(cfg_commision_percent)+"%;\n"
_text+="Condition:"+tostring(deal_start_type)+""
ifdeal_start_type=="RSI-7"
_text+=tostring(rsi_start_operation)
_text+=""+tostring(rsi_start_value)+"\n\n"
elseifdeal_start_type=="ExternalIndicator"
_text+="("
_text+=tostring(deal_start_operation)+""
_text+=tostring(deal_start_value)
_text+=")\n\n"
_text+="TP:"+tostring(cfg_take_profit_perc)+"%"
_text+="("+tostring(cfg_take_profit_type)+")"
ifcfg_enable_stop_loss
_text+="\nSL:"+tostring(cfg_stop_loss_perc)+"%"
_text+="\n\n"
_text+="BO:"+tostring(cfg_base_order_size_usd)+""+tostring(syminfo.currency)+";"
_text+="SO:"+tostring(cfg_safety_order_size_usd)+""+tostring(syminfo.currency)+";\n"
_text+="SOVolumeScale:"+tostring(cfg_safety_order_volume_scale)+";"
_text+="SOStepScale:"+tostring(cfg_safety_order_price_step_scale)+";\n"
_text+="SODev:"+tostring(cfg_safety_order_price_deviation_perc)+"%;"
_text+="MaxSO:"+tostring(cfg_max_safety_orders)+";"
_text+="Covered:"+tostring(round(stepped_deviation(cfg_max_safety_orders),2))+"%;\n"
table.cell(settings,column=0,row=1,
text=_text,text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
//lab=""
//ifarray.size(statsarray_losing_deals_pnl)>0
//lab:=lab+"Losingdeals:\n"
//fori=0toarray.size(statsarray_losing_deals_pnl)-1
//lab:=lab+tostring(array.get(statsarray_losing_deals_pnl,i))+"\n"
//ifarray.size(statsarray_winning_deals_pnl)>0
//lab:=lab+"Winningdeals:\n"
//fori=0toarray.size(statsarray_winning_deals_pnl)-1
//lab:=lab+tostring(array.get(statsarray_winning_deals_pnl,i))+"\n"
//f_print(lab)
//----------------------------------------------------------------
Expand (1411 lines)
