Script Name: Zendog V3 backtest DCA bot 3commas
Author: zendog123
Description: MAJOR UPDATE:
- Update to Pinescript v5
- MAJOR refactor for the logic of how orders are placed. BO order is placed when the condition is first encountered and we are not in a deal.
The extra SO orders (if based on price movement) are all placed on the next candle after BO order, instead of each being placed one after another.
Take profit (if percentage) and Stop...
PineScript code:

Pine Scriptâ„¢ strategy
Zendog V3 backtest DCA bot 3commas
//  Commited  version  390
//  IMPROVEMENTS/TODO:
//-  for  better  execution  time  use  static  bgcolor  values
//-  remove  disposable  variables
//-  avoid  concatenating  strings
//-  improve  UI  code  /  tables  with  functions  /  lighter  approaches
//-  fix  bugs  when  BO/SL/TP  are  on  the  same  candle
//  REMOVED
//  count_placed_safety_orders
//  glb_next_safety_order_qty
//  glb_current_deal_prev_position_size
//@author  zendog123
//@version=5
strategy(title='Zendog  V3  backtest  DCA  bot  3commas',  shorttitle='Zendog  V3  DCA',
  overlay=true,  max_labels_count=500,  pyramiding=99,  initial_capital=10000,
    calc_on_order_fills=false,  commission_type=strategy.commission.percent,  commission_value=0.075)
//used  for  labels
cfg_theme  =  input.string(defval='dark',  title='Chart  theme',  options=['light',  'dark'])
theme_text_color  =  cfg_theme  ==  'dark'  ?  color.white  :  color.black
f_print(_text)  =>
        //  Create  label  on  the  first  bar.
        var  _label  =  label.new(x=bar_index,  y=na,  text=str.tostring(_text),  xloc=xloc.bar_index,  yloc=yloc.price,  color=color.blue,  style=label.style_label_up,  textcolor=theme_text_color,  size=size.normal,  textalign=text.align_left)
        //  On  next  bars,  update  the  label's  x  and  y  position,  and  the  text  it  displays.
        if  barstate.islastconfirmedhistory
                label.set_xy(_label,  bar_index,  low  *  0.99)
                label.set_text(_label,  str.tostring(_text))
//----------------------------------------------
//STRATEGY  STUFF  STARTS  HERE
//deal  start  &  stop
string  _tooltip  =  "RSI-7:  Use  the  builtin  RSI-7  indicator  (set  trigger  values  down  below)\nExternal  Indicator:  plugin  an  external  indicator.  Make  sure  the  indicator  plots  a  value  and  configure  down  below  the  trigger  point  (greater  than  X,  less  than  X,  equal  to  X)  "
deal_start_condition  =  false
deal_start_type  =  input.string(defval='RSI-7',  title='Deal  start  type',  options=['RSI-7',  'External  Indicator'],  group='Deal  start  &  end  conditions',  tooltip=_tooltip)
string  _tooltip1  =  "Take  Profit:  End  deal  when  the  price  reached  a  %  TP\nExternal  Indicator:  End  deal  usinganexternalindicator(configuresettingsbelow)"
deal_end_condition=false
deal_end_type=input.string(defval='TakeProfit',title='Dealendtype',options=['TakeProfit','ExternalIndicator'],group='Dealstart&endconditions',tooltip=_tooltip1)
string_tooltip2="Percentage:OpenSOorderseveryN%ofpricemovement.Thepriceandsizearecalculatedaccordingtosettingsbelow(stepscale,volumescale)\nExternalindicator:OpenSOordersusinganexternalindicator(configuresettingsbelow)"
safety_order_condition=false
safety_order_type=input.string(defval='Percentage',title='Safetyordertype',options=['Percentage','ExternalIndicator'],group='Dealstart&endconditions',tooltip=_tooltip2)
string_tooltip3="Selectexternalindicator"
floatexternal_indicator=input.source(defval=close,title='Externalindicator',group='Dealstart&endconditions',tooltip=_tooltip3)
string_tooltip4="ComparisonforDealstart[greaterorequalthan,smallerorequalthan,exactlyequal]\nIfforexampletheexternalindicatorisRSIdealcouldstartwhenRSI7<=20"
stringdeal_start_operation=input.string(defval='=',title='Dealstartoperator',group='Dealstart&endconditions',options=['<=','=','>='],tooltip=_tooltip4)
string_tooltip5="Valueofexternalindicatorfordealstart"
floatdeal_start_value=input.float(defval=-99999,title='Dealstartvalue',group='Dealstart&endconditions',tooltip=_tooltip5)
string_tooltip6="ComparisonforDealend[greaterorequalthan,smallerorequalthan,exactlyequal]\nIfforexampletheexternalindicatorisRSIdealcouldendwhenRSI7>=80"
stringdeal_end_operation=input.string(defval='=',title='Dealendoperator',group='Dealstart&endconditions',options=['<=','=','>='],tooltip=_tooltip6)
string_tooltip7="ValueofExternalindicatorfordealend"
floatdeal_end_value=input.float(defval=-99999,title='Dealendvalue',group='Dealstart&endconditions',tooltip=_tooltip7)
string_tooltip8="ComparisonforSafetyorder[greaterorequalthan,smallerorequalthan,exactlyequal]\nIfforexampletheexternalindicatorisRSItriggeradditionalsafetyordereverytimeRSI7<=10.\nATTENTION!Thisdoesnottakeintoconsiderationthepricevalue,soalowRSIdoesnotmeanalowerpriceaswell"
stringsafety_order_operation=input.string(defval='=',title='Safetyorderoperator',group='Dealstart&endconditions',options=['<=','=','>='],tooltip=_tooltip8)
string_tooltip9="Valueofexternalindicatortotriggersafetyorders"
floatsafety_order_value=input.float(defval=-99999,title='Safetyordervalue',group='Dealstart&endconditions',tooltip=_tooltip9)
stringrsi_start_operation=input.string(defval='<=',title='RSI-7Operation',group='RSI7(ifusedforDealstarttrigger)',options=['<=','>='])
rsi_start_value=input.int(defval=30,title='RSI-7Value',group='RSI7(ifusedforDealstarttrigger)')
//---------DEALSTARTCONDITION----------
//RSI-7
ifdeal_start_type=='RSI-7'andrsi_start_operation=='<='
deal_start_condition:=ta.rsi(close,7)<=rsi_start_value
elseifdeal_start_type=='RSI-7'andrsi_start_operation=='>='
deal_start_condition:=ta.rsi(close,7)>=rsi_start_value

//MAYBEFOUNDABUG-->Leaveallif'sonthislevelotherwisetheydonotwork
elseifdeal_start_type=='ExternalIndicator'anddeal_start_value!=-99999anddeal_start_operation=='='andexternal_indicator==deal_start_value
deal_start_condition:=true
elseifdeal_start_type=='ExternalIndicator'anddeal_start_value!=-99999anddeal_start_operation=='<='andexternal_indicator<=deal_start_value
deal_start_condition:=true
elseifdeal_start_type=='ExternalIndicator'anddeal_start_value!=-99999anddeal_start_operation=='>='andexternal_indicator>=deal_start_value
deal_start_condition:=true
else
deal_start_condition:=false
//-----------------------------------------
//---------DEALENDCONDITION-----------
ifdeal_end_type=='ExternalIndicator'anddeal_end_value!=-99999anddeal_end_operation=='='andexternal_indicator==deal_end_value
deal_end_condition:=true
elseifdeal_end_type=='ExternalIndicator'anddeal_end_value!=-99999anddeal_end_operation=='<='andexternal_indicator<=deal_end_value
deal_end_condition:=true
elseifdeal_end_type=='ExternalIndicator'anddeal_end_value!=-99999anddeal_end_operation=='>='andexternal_indicator>=deal_end_value
deal_end_condition:=true
else
deal_end_condition:=false
//-----------------------------------------
//---------SAFETYORDERCONDITION-----------
ifsafety_order_type=='ExternalIndicator'andsafety_order_value!=-99999andsafety_order_operation=='='andexternal_indicator==safety_order_value
safety_order_condition:=true
elseifsafety_order_type=='ExternalIndicator'andsafety_order_value!=-99999andsafety_order_operation=='<='andexternal_indicator<=safety_order_value
safety_order_condition:=true
elseifsafety_order_type=='ExternalIndicator'andsafety_order_value!=-99999andsafety_order_operation=='>='andexternal_indicator>=safety_order_value
safety_order_condition:=true
else
safety_order_condition:=false
//-----------------------------------------
//strategytimeframelimitation(runjustbetweenspecificdates)
limit_date_range=input.bool(title='LimitDateRange',defval=false,group='Backtestdaterange')
//Inputoptionsthatconfigurebacktestdaterange
start_time=input.time(defval=timestamp('01Jan202200:00+0000'),title='StartTime',group='Backtestdaterange')
end_time=input.time(defval=timestamp('31Dec202200:00+0000'),title='EndTime',group='Backtestdaterange')
in_date_range=true
iflimit_date_range
in_date_range:=time>=start_timeandtime<=end_time

else
in_date_range:=true

cfg_strategy_type=input.string(title='StrategyType',defval='long',options=['long','short'],group='Strategysettings')
varboolIS_LONG=cfg_strategy_type=='long'
floatcfg_base_order_size_usd=input.float(title='Baseordersize',defval=1000,step=1000,group='Strategysettings')
floatcfg_safety_order_size_usd=input.float(title='Safetyordersize',defval=700,step=100,group='Strategysettings')
cfg_take_profit_type=input.string(title='TakeProfitType',defval='%Fromtotalvolume',options=['%Frombaseorder','%Fromtotalvolume'],group='Strategysettings')
floatcfg_take_profit_perc=input.float(title='TakeProfit(%)',minval=0.0,step=0.1,defval=2,group='Strategysettings')
boolcfg_enable_stop_loss=input.bool(title='EnableStopLoss',defval=false,group='Strategysettings')
floatcfg_stop_loss_perc=input.float(title='StopLoss(%)',minval=0.0,step=0.1,defval=20,group='Strategysettings')
floatcfg_max_safety_orders=input.float(title='MaxSafetyTradesCount',defval=5,group='Strategysettings')
floatcfg_safety_order_price_deviation_perc=input.float(title='PriceDeviationToOpenSafetyTrades(%)',minval=0.0,step=0.1,defval=3,group='Strategysettings')
floatcfg_safety_order_volume_scale=input.float(title='SafetyOrderVolumeScale',defval=1,step=0.1,group='Strategysettings')
floatcfg_safety_order_price_step_scale=input.float(title='SafetyOrderStepScale',defval=1,step=0.1,group='Strategysettings')
intcfg_planb_timeout=input.int(title='PLAN-BTimeout',defval=1,step=1,group='PLAN-B',tooltip='TimeouttoactivatePLAN-B.Use\'none\'inthedropdownbelowtodisablePLAN-B')
cfg_planb_timeout_type=input.string(title='',defval='none',options=['none','min','hour','day'],group='PLAN-B')
cfg_planb_action=input.string(title='PLAN-BAction',defval='none',options=['none','paintonly','closedeal'],group='PLAN-B')
floatcfg_planb_take_profit=input.float(title='PLAN-BCloseDeal(%)',defval=0.5,step=0.1,group='PLAN-B',tooltip='Alternative%fromtotalvolume(versusposition_avg_size)tousewhenPLAN-Bisactivated.\nItiseitherapositive%foralternativeTPoranegative%foralternativeSL')
get_planb_timeout()=>
float_timeout=0
ifcfg_planb_timeout_type=='day'
_timeout:=cfg_planb_timeout*86400000
elseifcfg_planb_timeout_type=='hour'
_timeout:=cfg_planb_timeout*3600000
elseifcfg_planb_timeout_type=='min'
_timeout:=cfg_planb_timeout*60000
//calculateonlyonce
varfloatglb_planb_timeout=get_planb_timeout()
string_tooltip_bot_control='IfthisisenabledthestrategycancontrolsomebotoperationsviaWebhookcalls.\n\nToenableWebhookcalls,checkthisoption,completeBotidandEmailToken.Afterthestrategyisconfigured,createanalertonthestrategy,selectOrderfillsonly,andinthemessagefieldsimplyinput{{strategy.order.alert_message}}.'
boolcfg_enable_bot_control=input.bool(title='EnableBotControlViaWebhook',defval=false,group='3commasBotSettings',tooltip=_tooltip_bot_control)
stringcfg_bot_id=input.string(title='Botid',defval='',group='3commasBotSettings')
stringcfg_email_token=input.string(title='Emailtoken',defval='',group='3commasBotSettings')
boolcfg_exec_deal_start=input.bool(title='Dealstart',defval=true,group='3commasBotSettings')
boolcfg_exec_safety_order=input.bool(title='SafetyOrders',defval=true,group='3commasBotSettings',
tooltip="Thestrategywillsendamessagetoaddfundsinthequotecurrency(forBTCUSDTquoteisUSDT).TheamountoffundsarecalculatedbasedonSOsettings(size,volumesteps).Forexactvaluesusethestepstable.")
boolcfg_exec_take_profit=input.bool(title='Takeprofitdealstop',defval=true,group='3commasBotSettings')
boolcfg_exec_external_indicator=input.bool(title='Externalindicatordealstop',defval=true,group='3commasBotSettings')
boolcfg_exec_stop_loss=input.bool(title='StopLoss',defval=true,group='3commasBotSettings')
boolcfg_exec_planb_timeout=input.bool(title='PLAN-B',defval=true,group='3commasBotSettings')
floatcfg_commision_percent=input.float(title='Commision(%)',minval=0.0,step=0.001,defval=0.075,group='Broker')
//visuals
intcfg_decimals=input.int(title='DecimalsForDisplay',defval=2,group='Visuals')
boolcfg_show_pnl_labels=input.bool(title='ShowPnLLabels',defval=true,group='Visuals')
boolcfg_show_stats_table=input.bool(title='ShowTableWithStatistics',defval=true,group='Visuals')
boolcfg_show_settings_table=input.bool(title='ShowTableWithStrategySettings',defval=false,group='Visuals')
boolcfg_show_step_table=input.bool(title='ShowTableWithStepsSimilarTo3commas',defval=false,group='Visuals',tooltip='MakesuretheTablewithStrategySettingsisdisabledbecausetheyusethesameposition\n\nIftheSafetyorderstypeisnotpercentageallsignificantvalueswillbereplacedby-(dashes)')
floatcfg_steps_bo_price=input.float(title='BOEntryPriceForStepsTable',defval=0,group='Visuals',tooltip="CustomBOpriceusedtocalculatealltablevalues.Ifthisisnotconfigured,theclosevaluewillbeused")
//Howmanysafetyorderswereplacedincurrenttrade
//REMOVED
//varintcount_placed_safety_orders=0
//howmanysafetyorderswereexecutedincurrenttrade
varintcount_executed_safety_orders=0
varfloatglb_take_profit_price=na
varfloatglb_planb_timeout_price=na
varfloatglb_stop_loss_price=na
varfloatglb_base_order_price=na
varfloatglb_base_order_qty=na
varfloatglb_next_safety_order_price=na
//REMOVED
//varfloatglb_next_safety_order_qty=na
//calculatedbasedonBOsize,SOsize,andsteps
varfloatglb_required_capital=na
//usedforstatsandtocalculatecommision
varfloatglb_total_volume=0
//weusethesevariablestorememberpositionsizeanduseit
//tocalculatepnlafterthedealwasclosed
varfloatglb_current_deal_position_size=na
varfloatglb_current_deal_avg_price=na
//REMOVED
//varfloatglb_current_deal_prev_position_size=na
//Usedtotrytoobtainrealpricesforordersalreadyexecuted
varfloatglb_strategy_prev_netprofit=0
//Theseremainglobalbecauseofexecutionimprovement
varfloatglb_current_deal_close_value=0
varfloatglb_current_deal_pnl=0
//usedasaflagforcodelogic
varboolglb_still_in_deal=false
varstringglb_debug_text=""
vardebug_printed=false
//usedtoavoidplacingSOordersoverandoveragain
//needstoberesetonceatradeisclosed
//false-SOordersnotplaced
//true-SOordersalreadyplace
varboolglb_so_orders_placed=false
//arraythatholdsstatsforusedSO
varint[]statsarray_safety_orders=array.new_int(0)
varint[]statsarray_safety_orders_timeout=array.new_int(0)
varintglb_dealstart_bar_index=0
varint[]statsarray_no_of_bars=array.new_int(0)
varintglb_dealstart_bar_time=0
varfloat[]statsarray_no_of_days=array.new_float(0)
varfloatstats_max_days_in_deal=0
varstats_max_days_in_deal_start_time=0
varstats_max_days_in_deal_close_time=0
varboolfirstdeal_started=false
varintfirstdeal_bar_index=0
varfloatfirstdeal_start_price=0
varfirstdeal_start_time=0
varintlastdeal_close_bar_index=0
varlastdeal_close_time=0
//buyandholdstats
varfloatbh_start_price=0
varbh_start_time=0
varfloatbh_end_price=0
varbh_end_time=0
varboolbh_calculation_started=false
//maxdrawndowninadealvsavgpositionprice
varfloatstats_max_drawdown=0
varstats_max_drawdown_time=0
varfloatstats_max_drawdown_equity_percent=0
//biggestpercentdeviationvsbaseorder
varfloatstats_biggest_dev=0
varstats_biggest_dev_time=0
varfloatstats_deals_started=0
varfloatstats_deals_finished=0
varfloatstats_deals_stop_loss_finished=0
varfloatstats_deals_take_profit_finished=0
varfloatstats_deals_timeout_finished=0
//willkeepprofit/losses
varfloat[]statsarray_winning_deals_pnl=array.new_float(0)
varfloat[]statsarray_losing_deals_pnl=array.new_float(0)
varfloat[]statsarray_timeout_deals_pnl=array.new_float(0)
//FUNCTIONS
//so_index0isforBO,from1..nonitisforSOn
//calculatespercentsonoadjustmentforlongvsshort
stepped_deviation(so_index)=>
float_stepped_deviation=0
ifso_index>0
for_i=1toso_indexby1
_stepped_deviation:=_stepped_deviation+cfg_safety_order_price_deviation_perc*math.pow(cfg_safety_order_price_step_scale,_i-1)
else
_stepped_deviation:=0
//Returnsrequriedpriceinordertoachievespecificpercentage
steps_required_price(_bo_price,_avg_price,_pos_size,_take_profit_percent)=>
float_price=0
ifcfg_take_profit_type=='%Fromtotalvolume'
ifIS_LONG
_required_price=_avg_price*(1+_take_profit_percent/100)
else
_required_price=_avg_price*(1-_take_profit_percent/100)

elseifcfg_take_profit_type=="%Frombaseorder"
ifIS_LONG
_req_usdt=cfg_base_order_size_usd*cfg_take_profit_perc/100
_required_price=((_avg_price*_pos_size)+_req_usdt)/_pos_size
else
_req_usdt=cfg_base_order_size_usd*cfg_take_profit_perc/100
_required_price=((_avg_price*_pos_size)-_req_usdt)/_pos_size
//Returnsthe%neededfor_last_pricetoreach_required_price
steps_required_percent(_last_price,_required_price)=>
ifIS_LONG
_required_percent=math.round((_required_price*100/_last_price)-100,2)
else
_required_percent=math.round(100-(_required_price*100/_last_price),2)
valid_stop_loss()=>
bool_valid=false
ifcfg_enable_stop_loss
//stoplosspercentisbiggerthanlastsafetyorderpercent
if(safety_order_type=='Percentage'andcfg_stop_loss_perc>stepped_deviation(cfg_max_safety_orders))
_valid:=true
elseif(safety_order_type=='ExternalIndicator')
_valid:=true
else
_valid:=false
else
_valid:=false
next_so_price(so_index,_bo_price)=>
float_stepped_deviation=stepped_deviation(so_index)
ifIS_LONG
float_next_so_price=_bo_price*(1-_stepped_deviation/100)
else
float_next_so_price=_bo_price*(1+_stepped_deviation/100)
next_so_size_usd(so_index)=>
float_next_so_size_usd=cfg_safety_order_size_usd*math.pow(cfg_safety_order_volume_scale,so_index-1)
next_so_qty(so_index,_bo_price)=>
float_next_so_size_usd=next_so_size_usd(so_index)
float_next_so_qty=_next_so_size_usd/next_so_price(so_index,_bo_price)
is_planb_timeout()=>
_res=false
ifna(glb_dealstart_bar_time)==false
iftime-glb_dealstart_bar_time>=glb_planb_timeout
_res:=true
else
_res:=false
get_required_capital()=>
float_total_buy=0
ifcfg_max_safety_orders>0
_total_buy:=_total_buy+cfg_base_order_size_usd
for_i=1tocfg_max_safety_ordersby1
_total_buy:=_total_buy+next_so_size_usd(_i)
else
_total_buy:=_total_buy+cfg_base_order_size_usd
get_days(start_time,end_time)=>
time_diff=end_time-start_time
diff_days=math.round(time_diff/86400000,1)
get_timestring_from_seconds(seconds)=>
ifseconds>=86400
string_string=str.tostring(math.round(seconds/86400,1))+'days'
elseifseconds>=3600
string_string=str.tostring(math.round(seconds/3600,1))+'hours'
else
string_string=str.tostring(math.round(seconds/60,1))+'mins'
get_timestring_from_days(days)=>
get_timestring_from_seconds(days*86400)
get_timespan_string(start_time,end_time)=>
_seconds_diff=(end_time-start_time)/1000
get_timestring_from_seconds(_seconds_diff)
//f_print(get_timestring_from_days(0.5)+"\n"+get_timestring_from_days(0.01)+"\n"+get_timestring_from_days(0.7))
get_commission_for_volume(vol)=>
_commision=vol*cfg_commision_percent/100
get_final_pnl_new()=>
float_pnl=0
ifarray.size(statsarray_losing_deals_pnl)>0
_pnl:=_pnl+array.sum(statsarray_losing_deals_pnl)
ifarray.size(statsarray_winning_deals_pnl)>0
_pnl:=_pnl+array.sum(statsarray_winning_deals_pnl)
//addorsubstractcurrentdealopenprofit
//commissionisalreadysubstracted
_pnl:=_pnl+strategy.openprofit
get_final_pnl_prct_new()=>
get_final_pnl_new()*100/glb_required_capital
//take_profit_price(_avg_price=strategy.position_avg_price,_position_size=strategy.position_size)=>
take_profit_price(_avg_price=strategy.position_avg_price,_pos_size=strategy.position_size)=>
ifcfg_take_profit_type=="%Fromtotalvolume"
ifIS_LONG
_tp_price=_avg_price*(1+cfg_take_profit_perc/100)
else
_tp_price=_avg_price*(1-cfg_take_profit_perc/100)
elseifcfg_take_profit_type=="%Frombaseorder"
ifIS_LONG
_tp_size_usd=cfg_base_order_size_usd*cfg_take_profit_perc/100
_tp_price=((_avg_price*_pos_size)+_tp_size_usd)/_pos_size
else
_tp_size_usd=cfg_base_order_size_usd*cfg_take_profit_perc/100
_tp_price=((_avg_price*_pos_size)-_tp_size_usd)/_pos_size
planb_timeout_price()=>
ifIS_LONG
_price=strategy.position_avg_price*(1+float(cfg_planb_take_profit)/100)

else
_price=strategy.position_avg_price*(1-float(cfg_planb_take_profit)/100)
stop_loss_price(_bo_price)=>
ifIS_LONG
_bo_price*(1-cfg_stop_loss_perc/100)
else
_bo_price*(1+cfg_stop_loss_perc/100)
take_profit_price_hit()=>
ifIS_LONG
high>=glb_take_profit_priceandstrategy.position_size==0
else
low<=glb_take_profit_priceandstrategy.position_size==0
planb_price_hit()=>
ifIS_LONG
high>=glb_planb_timeout_priceandstrategy.position_size==0
else
low<=glb_planb_timeout_priceandstrategy.position_size==0
stop_loss_price_hit()=>
bool_cond=false
ifvalid_stop_loss()
ifIS_LONG
_cond:=low<=glb_stop_loss_priceandstrategy.position_size==0
else
_cond:=high>=glb_stop_loss_priceandstrategy.position_size==0
else
_cond:=false
get_current_dev_vs_bo_price()=>
ifIS_LONG
_dev=low*100/glb_base_order_price-100
else
_dev=100-high*100/glb_base_order_price
get_current_drawdown_equity()=>
_deal_total_value=strategy.position_size*strategy.position_avg_price
ifIS_LONG
_drawdown_actual_value=strategy.position_size*low
_drawdown_equity_percent=_drawdown_actual_value*100/_deal_total_value-100
else
_drawdown_actual_value=strategy.position_size*high
_drawdown_equity_percent=100-_drawdown_actual_value*100/_deal_total_value
//Teststhesizeofthepositionsize
is_deal_started()=>
bool_flag=false
ifIS_LONGandstrategy.position_size>0
_flag:=true
elseifnotIS_LONGandstrategy.position_size<0
_flag:=true
else
_flag:=false
//Afteradealiscompletedweneedtoresetspecificvariables
was_deal_marked_as_finished()=>
//Ifwearenotinadealanymorebutsomeglobalvariablewasnotresetyet
ifglb_still_in_deal==true
_state=false
else
_state=true
//initarraywith0values
init_stats_array_safety_orders()=>
for_i=0tocfg_max_safety_ordersby1
array.push(statsarray_safety_orders,0)
array.push(statsarray_safety_orders_timeout,0)
get_3cbot_startdeal_json()=>
_string='{"message_type":"bot","bot_id":"'+cfg_bot_id+'","email_token":"'+cfg_email_token+'","delay_seconds":0,"pair":"'+str.tostring(syminfo.currency)+'_'+str.tostring(syminfo.basecurrency)+'"}'
get_3cbot_stopdeal_json()=>
_string='{"action":"close_at_market_price_all","message_type":"bot","bot_id":"'+cfg_bot_id+'","email_token":"'+cfg_email_token+'","delay_seconds":0,"pair":"'+str.tostring(syminfo.currency)+'_'+str.tostring(syminfo.basecurrency)+'"}'
get_3cbot_addfundsinquote_json(add_volume=0)=>
_string='{"action":"add_funds_in_quote","message_type":"bot","bot_id":"'+cfg_bot_id+'","email_token":"'+cfg_email_token+'","delay_seconds":0,"volume":"'+str.tostring(add_volume)+'"}'
get_month_string(month_number)=>
ifmonth_number==1
_string='Jan'
elseifmonth_number==2
_string='Feb'
elseifmonth_number==3
_string='Mar'
elseifmonth_number==4
_string='Apr'
elseifmonth_number==5
_string='May'
elseifmonth_number==6
_string='Jun'
elseifmonth_number==7
_string='Jul'
elseifmonth_number==8
_string='Aug'
elseifmonth_number==9
_string='Sep'
elseifmonth_number==10
_string='Oct'
elseifmonth_number==11
_string='Nov'
elseifmonth_number==12
_string='Dec'
time_to_date_string(timeinms)=>
iftimeinms>0
_string=str.tostring(dayofmonth(timeinms),'00/')+get_month_string(month(timeinms))+'/'+str.tostring(year(timeinms),'0000')+''+str.tostring(hour(timeinms),'00:')+str.tostring(minute(timeinms),'00:')+str.tostring(second(timeinms),'00')
else
_string=''
get_bg_color_grey(row)=>
_bgcolor=row%2==0?#CACACA:#E5E5E5
get_bg_color_blue(transp=0)=>
_bgcolor=color.new(#006bb3,transp)
get_bg_color_green(transp=0)=>
_bgcolor=color.new(#A6E59B,transp)
get_bg_color_red(transp=0)=>
_bgcolor=color.new(#E59B9B,transp)
get_bg_color_lightblue(transp=0)=>
_bgcolor=color.new(#00BFFF,transp)
get_bg_color_orange(transp=0)=>
_bgcolor=color.new(#FFA500,transp)
//statsforbuyandholdreturn
ifin_date_rangeandbh_calculation_started==false
bh_start_price:=open
bh_start_time:=time
bh_calculation_started:=true
bh_end_price:=close
bh_end_time:=time_close
//updatestatsforbuyandholdaslongaswe'restillinsidedaterange
ifin_date_range
bh_end_price:=close
bh_end_time:=time_close
//conditionforbaseorder
ifin_date_rangeanddeal_start_conditionandnotis_deal_started()andwas_deal_marked_as_finished()
//statsforthefirstdeal
iffirstdeal_started==false
firstdeal_started:=true
firstdeal_bar_index:=bar_index
firstdeal_start_price:=close
firstdeal_start_time:=time
init_stats_array_safety_orders()
glb_still_in_deal:=true
stats_deals_started:=stats_deals_started+1
glb_dealstart_bar_index:=bar_index
glb_dealstart_bar_time:=time
//Adjustglb_strategy_prev_netprofitbeforestartinganewdealifdifferentthanthepinescriptstrategy
//Thissolvesabugwhenpinescriptsellsatasligthlydifferentpricethanthecloseprice.
//Casewasfoundwhenclosingdealfromexternalindicator
ifglb_strategy_prev_netprofit!=strategy.netprofit
glb_strategy_prev_netprofit:=strategy.netprofit
//howmanycoins
glb_base_order_qty:=cfg_base_order_size_usd/close
//Thisvaluewillbeoverwrittenwiththeactualexecutedmarketpriceonthenextcandle
glb_base_order_price:=close
//enterwithmarketorderbecausewithlimitordertheopenofnextcandlemightbeabitdifferent
//thancloseofcurrentcandleandthedealmightnotstart
_alert_human='D'+str.tostring(stats_deals_started)+'-BO('+str.tostring(syminfo.basecurrency)+'-'+
str.tostring(syminfo.currency)+(cfg_strategy_type=='long'?'LONG':'SHORT')+')|'+
str.tostring(glb_base_order_qty*glb_base_order_price)+''+str.tostring(syminfo.currency)
ifcfg_enable_bot_controlandcfg_exec_deal_start
_alert_json=get_3cbot_startdeal_json()
strategy.entry(id='D'+str.tostring(stats_deals_started)+'-BO',direction=IS_LONG?strategy.long:strategy.short,
qty=glb_base_order_qty,alert_message=_alert_json)
alert(_alert_human,alert.freq_once_per_bar_close)
else
strategy.entry(id='D'+str.tostring(stats_deals_started)+'-BO',direction=IS_LONG?strategy.long:strategy.short,
qty=glb_base_order_qty)
alert(_alert_human,alert.freq_once_per_bar_close)

//ifweareinadeal
ifis_deal_started()andnotwas_deal_marked_as_finished()

//------------------------
//ONLYBOWASEXECUTED
//IftheonlyexecutedorderisBO,overwriteSLpriceandBOpriceandsizebasedonexecutedvalues
//takenfromstragey.xxxvariables
ifstrategy.opentrades==1andnotglb_so_orders_placed
glb_so_orders_placed:=true
glb_base_order_price:=strategy.position_avg_price
glb_base_order_qty:=strategy.position_size

count_executed_safety_orders:=0

glb_debug_text+="BO:"+str.tostring(math.round(glb_base_order_qty,cfg_decimals))+"*"+
str.tostring(math.round(glb_base_order_price,cfg_decimals))+"="+str.tostring(glb_base_order_qty*glb_base_order_price)+"\n"
//placeallPercentageSOordersaslimitorders
ifcfg_max_safety_orders>0andsafety_order_type=='Percentage'
for_so_number=1tocfg_max_safety_orders
_next_so_price=next_so_price(_so_number,glb_base_order_price)
_next_so_qty=next_so_qty(_so_number,glb_base_order_price)
_next_so_size_usd=next_so_size_usd(_so_number)

//placesafetyorderaslimitorder

//----------------------------
//Iguessthereisnoreasontosendhumanreadeablealertstothebot,sothissection
//iscommentedout.Feelfreetore-usethisifyourareinterestedinsendingnotificationsat
//thesametimethestrategyordertriggers(otherwisenotificationsaredelayeduntilthenextcandle)
//----------------------------

//_alert="D"+tostring(stats_deals_started)+"-SO"+tostring(_so_number)+"("+
//tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
//(cfg_strategy_type=="long"?"LONG":"SHORT")+")|"+
//tostring(_next_so_qty*_next_so_price)+""+tostring(syminfo.currency)
//strategy.entry(id="D"+tostring(stats_deals_started)+"-SO"+tostring(_so_number),
//long=IS_LONG,qty=_next_so_qty,limit=_next_so_price,alert_message=_alert)

glb_debug_text+="SO"+str.tostring(_so_number)+":"+str.tostring(math.round(_next_so_qty,cfg_decimals))+"*"+
str.tostring(math.round(_next_so_price,cfg_decimals))+"="+str.tostring(_next_so_qty*_next_so_price)+"\n"

ifcfg_enable_bot_controlandcfg_exec_safety_order
_alert_json=get_3cbot_addfundsinquote_json(_next_so_size_usd)
strategy.entry(id='D'+str.tostring(stats_deals_started)+'-SO'+str.tostring(_so_number),
direction=IS_LONG?strategy.long:strategy.short,qty=_next_so_qty,limit=_next_so_price,alert_message=_alert_json)
else
strategy.entry(id='D'+str.tostring(stats_deals_started)+'-SO'+str.tostring(_so_number),
direction=IS_LONG?strategy.long:strategy.short,qty=_next_so_qty,limit=_next_so_price)
//usedforplot
glb_next_safety_order_price:=next_so_price(1,glb_base_order_price)

//createSLorderaslimit
ifvalid_stop_loss()
glb_stop_loss_price:=stop_loss_price(glb_base_order_price)

glb_debug_text+="SL:"+str.tostring(glb_stop_loss_price)+"\n"

ifcfg_enable_bot_controlandcfg_exec_stop_loss
_alert_json=get_3cbot_stopdeal_json()
strategy.exit(id='D'+str.tostring(stats_deals_started)+'-SL',stop=glb_stop_loss_price,
when=is_deal_started(),alert_message=_alert_json)
else
//----------------------------
//Iguessthereisnoreasontosendhumanreadeablealertstothebot,sothissection
//iscommentedout.Feelfreetore-usethisifyourareinterestedinsendingnotificationsat
//thesametimethestrategyordertriggers(otherwisenotificationsaredelayeduntilthenextcandle)
//----------------------------

//_alert_human="D"+tostring(stats_deals_started)+"-SL("+
//tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
//(cfg_strategy_type=="long"?"LONG":"SHORT")+")"
//strategy.exit(id="D"+tostring(stats_deals_started)+"-SL",
//stop=glb_stop_loss_price,when=is_deal_started(),alert_message=_alert_human)

strategy.exit(id='D'+str.tostring(stats_deals_started)+'-SL',stop=glb_stop_loss_price,when=is_deal_started())

//------------------------
//ATLEASTONESAFETYORDER(PERCENTAGE)WASEXECUTEDINTHEMEANTIME
//Updatestatisticsandsendalerts
ifstrategy.opentrades>(count_executed_safety_orders+1)andsafety_order_type=='Percentage'
for_i=count_executed_safety_orders+1tostrategy.opentrades
_next_so_price=next_so_price(_i,glb_base_order_price)
_next_so_qty=next_so_qty(_i,glb_base_order_price)
//delayedalertaboutpreviousSOexecution
_alert_human='D'+str.tostring(stats_deals_started)+'-SO'+str.tostring(_i)+'[delayed]('+
str.tostring(syminfo.basecurrency)+'_'+str.tostring(syminfo.currency)+
(cfg_strategy_type=='long'?'LONG':'SHORT')+')|'+
str.tostring(_next_so_price*_next_so_qty)+''+str.tostring(syminfo.currency)
alert(_alert_human,alert.freq_once_per_bar_close)

//updatetocurrentopentrades
count_executed_safety_orders:=(strategy.opentrades-1)

//forvisualplot
ifcount_executed_safety_orders<cfg_max_safety_orders
glb_next_safety_order_price:=next_so_price(count_executed_safety_orders+1,glb_base_order_price)
elseifcount_executed_safety_orders==cfg_max_safety_orders
glb_next_safety_order_price:=na
//------------------------
//SAFETYORDERFROMEXTERNALINDICATOR
//Placesafetyorderasmarketorderatcurrentclose
ifsafety_order_type=='ExternalIndicator'andsafety_order_condition==trueandcount_executed_safety_orders<cfg_max_safety_orders
count_executed_safety_orders:=count_executed_safety_orders+1
_next_so_size_usd=next_so_size_usd(count_executed_safety_orders)
_next_so_qty=_next_so_size_usd/close

ifcfg_enable_bot_controlandcfg_exec_safety_order
_alert_json=get_3cbot_addfundsinquote_json(_next_so_size_usd)
strategy.entry(id='D'+str.tostring(stats_deals_started)+'-SO'+str.tostring(count_executed_safety_orders),
direction=IS_LONG?strategy.long:strategy.short,qty=_next_so_qty,alert_message=_alert_json)
else
strategy.entry(id='D'+str.tostring(stats_deals_started)+'-SO'+str.tostring(count_executed_safety_orders),
direction=IS_LONG?strategy.long:strategy.short,qty=_next_so_qty)
_alert_human='D'+str.tostring(stats_deals_started)+'-SO'+str.tostring(count_executed_safety_orders)+'('+
str.tostring(syminfo.basecurrency)+'_'+str.tostring(syminfo.currency)+
(cfg_strategy_type=='long'?'LONG':'SHORT')+')|'+
str.tostring(_next_so_size_usd)+''+str.tostring(syminfo.currency)
alert(_alert_human,alert.freq_once_per_bar_close)


//------------------------
//GENERALUPDATESFOREACHCANDLE
//TAKEPROFIT
//RecalculateTPpricebasedoncurrentstrategy.position_avg_price
//andstrategy.position_sizeandUPDATEORDER

ifdeal_end_type=="TakeProfit"
glb_take_profit_price:=take_profit_price()

//PlaceorupdateTPorder
ifcfg_enable_bot_controlandcfg_exec_take_profit
_alert_json=get_3cbot_stopdeal_json()
strategy.order(id='D'+str.tostring(stats_deals_started)+'-TP',limit=glb_take_profit_price,
direction=IS_LONG?strategy.short:strategy.long,qty=math.abs(strategy.position_size),
when=is_deal_started(),alert_message=_alert_json)
else
//----------------------------
//Iguessthereisnoreasontosendhumanreadeablealertstothebot,sothissection
//iscommentedout.Feelfreetore-usethisifyourareinterestedinsendingnotificationsat
//thesametimethestrategyordertriggers(otherwisenotificationsaredelayeduntilthenextcandle)
//----------------------------

//_alert_human="D"+tostring(stats_deals_started)+"-TP("+
//tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
//(cfg_strategy_type=="long"?"LONG":"SHORT")+")"
//strategy.order(id="D"+tostring(stats_deals_started)+"-TP",limit=glb_take_profit_price,
//long=(IS_LONG?false:true),qty=math.abs(strategy.position_size),when=is_deal_started(),alert_message=_alert_human)

strategy.order(id='D'+str.tostring(stats_deals_started)+'-TP',limit=glb_take_profit_price,
direction=IS_LONG?strategy.short:strategy.long,qty=math.abs(strategy.position_size),
when=is_deal_started())

//hackbecauseifclausehasreturntype
string_dumb_string=""

else
glb_take_profit_price:=na

//hackbecauseifclausehasreturntype
string_dumb_string=""


//PLANB-TIMEOUTREACHED.Calculatetheprice
ifis_planb_timeout()andcfg_planb_action!='none'
glb_planb_timeout_price:=planb_timeout_price()
//PlaceorupdatePLANBorder
ifis_planb_timeout()andcfg_planb_action=='closedeal'
//CancelTPorderifany
strategy.cancel(id='D'+str.tostring(stats_deals_started)+'-TP')
ifcfg_enable_bot_controlandcfg_exec_planb_timeout
_alert_json=get_3cbot_stopdeal_json()
strategy.order(id='D'+str.tostring(stats_deals_started)+'-TIMEOUT',limit=glb_planb_timeout_price,
direction=IS_LONG?strategy.short:strategy.long,qty=math.abs(strategy.position_size),
when=is_deal_started(),alert_message=_alert_json)
else
//----------------------------
//Iguessthereisnoreasontosendhumanreadablealertstothebot,sothissection
//iscommentedout.Feelfreetore-usethisifyourareinterestedinsendingnotificationsat
//thesametimethestrategyordertriggers
//----------------------------

//_alert_human="D"+tostring(stats_deals_started)+"-TIMEOUT("+
//tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
//(cfg_strategy_type=="long"?"LONG":"SHORT")+")"
//strategy.order(id="D"+tostring(stats_deals_started)+"-TIMEOUT",limit=glb_planb_timeout_price,
//long=(IS_LONG?false:true),qty=math.abs(strategy.position_size),when=is_deal_started(),alert_message=_alert_human)

strategy.order(id='D'+str.tostring(stats_deals_started)+'-TIMEOUT',limit=glb_planb_timeout_price,
direction=IS_LONG?strategy.short:strategy.long,qty=math.abs(strategy.position_size),
when=is_deal_started())

//------------------------
//GENERALSTATISTICS
//savethesevariablesforpushingstatsafterthedealisfinished
glb_current_deal_position_size:=strategy.position_size
glb_current_deal_avg_price:=strategy.position_avg_price
//statsformaxdrawndown
ifstrategy.openprofit<stats_max_drawdown
stats_max_drawdown:=strategy.openprofit
stats_max_drawdown_equity_percent:=get_current_drawdown_equity()
//approx
stats_max_drawdown_time:=time
//Biggestdropvsbaseorderprice
_current_dev_vs_bo_price=get_current_dev_vs_bo_price()
if_current_dev_vs_bo_price<stats_biggest_dev
stats_biggest_dev:=_current_dev_vs_bo_price
//approx
stats_biggest_dev_time:=time

//DEBUG
//ifstrategy.opentrades==1andnotdebug_printed
//label.new(bar_index,high,text="D"+str.tostring(stats_deals_started),tooltip=glb_debug_text,yloc=yloc.price,
//textalign=text.align_left,size=size.normal,style=label.style_label_down,textcolor=color.black,color=get_bg_color_green())
//debug_printed:=true

//----------------------------------
//ISDEALFINISHEDONTHISCANDLE?
condition_take_profit=false
condition_stop_external_indicator=false
condition_stop_loss=false
condition_planb_timeout=false
//Ifmultipleconditionsaremetonthesamecandlethepriorityis:
//1.Stoploss
//2.Timeout
//3.Takeprofit
//4.Externalindicatorvaluehit
ifstop_loss_price_hit()andnotis_deal_started()andnotwas_deal_marked_as_finished()
condition_stop_loss:=true
elseifplanb_price_hit()andis_planb_timeout()andcfg_planb_action=='closedeal'
condition_planb_timeout:=true
elseifdeal_end_type=="TakeProfit"andtake_profit_price_hit()andnotis_deal_started()andnotwas_deal_marked_as_finished()
condition_take_profit:=true
elseifdeal_end_type=='ExternalIndicator'anddeal_end_condition==trueandis_deal_started()andnotwas_deal_marked_as_finished()
condition_stop_external_indicator:=true

condition_to_cancel_open_orders=condition_take_profitorcondition_stop_external_indicatororcondition_stop_lossorcondition_planb_timeout
//resetvariablesfornexttradeandpushstats
ifcondition_to_cancel_open_orders
strategy.cancel_all(when=condition_to_cancel_open_orders)

//commonstatsforallcases
stats_deals_finished:=stats_deals_finished+1
//addtoTotalVolumethecurerntdealVOLUMEuptothispoint(withoutexitorder)
glb_total_volume:=glb_total_volume+(glb_current_deal_position_size*glb_current_deal_avg_price)
_current_days_in_deal=get_days(glb_dealstart_bar_time,time)
array.push(statsarray_no_of_bars,bar_index-glb_dealstart_bar_index)
array.push(statsarray_no_of_days,_current_days_in_deal)
ifstats_max_days_in_deal<=_current_days_in_deal
stats_max_days_in_deal:=_current_days_in_deal
//approx
stats_max_days_in_deal_start_time:=glb_dealstart_bar_time
stats_max_days_in_deal_close_time:=time

//statisticsthatarespecifictoeachclosetype
ifcondition_stop_loss
stats_deals_stop_loss_finished:=stats_deals_stop_loss_finished+1
//ExtractingPNL.Thisisdifferentcalculationforeachdealclosetype
glb_current_deal_pnl:=strategy.netprofit-glb_strategy_prev_netprofit
glb_strategy_prev_netprofit:=strategy.netprofit
glb_current_deal_close_value:=glb_current_deal_position_size*glb_stop_loss_price
glb_total_volume:=glb_total_volume+glb_current_deal_close_value
array.push(statsarray_losing_deals_pnl,glb_current_deal_pnl)
ifcfg_show_pnl_labels
label.new(bar_index,glb_stop_loss_price,text=str.tostring(math.round(glb_current_deal_pnl,cfg_decimals))+
''+str.tostring(syminfo.currency)+'\n'+get_timespan_string(glb_dealstart_bar_time,time),
yloc=yloc.price,size=size.normal,style=label.style_label_down,textcolor=color.black,color=get_bg_color_red())
//delayedalertaboutdealclosebystoploss
_alert_human='D'+str.tostring(stats_deals_started)+'-SL[delayed]('+str.tostring(syminfo.basecurrency)+
'_'+str.tostring(syminfo.currency)+(cfg_strategy_type=='long'?'LONG':'SHORT')+')|'+
str.tostring(math.round(glb_current_deal_pnl,cfg_decimals))+''+str.tostring(syminfo.currency)+
'|'+get_timespan_string(glb_dealstart_bar_time,time)
alert(_alert_human,alert.freq_once_per_bar_close)
elseifcondition_planb_timeout
stats_deals_timeout_finished:=stats_deals_timeout_finished+1
//ExtractingPNL.Thisisdifferentcalculationforeachdealclosetype
glb_current_deal_pnl:=strategy.netprofit-glb_strategy_prev_netprofit
glb_strategy_prev_netprofit:=strategy.netprofit
//executesonopenprice
glb_current_deal_close_value:=glb_current_deal_position_size*open
glb_total_volume:=glb_total_volume+glb_current_deal_close_value
array.push(statsarray_timeout_deals_pnl,glb_current_deal_pnl)
ifglb_current_deal_pnl>=0
array.push(statsarray_winning_deals_pnl,glb_current_deal_pnl)
else
array.push(statsarray_losing_deals_pnl,glb_current_deal_pnl)
//increaseSOarrayaswellbutalsoaseparatethatholdstimeoutdealscount
array.set(statsarray_safety_orders,count_executed_safety_orders,array.get(statsarray_safety_orders,count_executed_safety_orders)+1)
array.set(statsarray_safety_orders_timeout,count_executed_safety_orders,array.get(statsarray_safety_orders_timeout,count_executed_safety_orders)+1)
ifcfg_show_pnl_labels
label.new(bar_index,glb_planb_timeout_price,text=''+str.tostring(math.round(glb_current_deal_pnl,cfg_decimals))+
''+str.tostring(syminfo.currency)+'\n'+get_timespan_string(glb_dealstart_bar_time,time),
yloc=yloc.price,size=size.normal,style=label.style_label_down,textcolor=color.black,color=get_bg_color_lightblue())
//delayedalertaboutdealclosebytimeout
_alert_human='D'+str.tostring(stats_deals_started)+'-TIMEOUT[delayed]('+
str.tostring(syminfo.basecurrency)+'_'+str.tostring(syminfo.currency)+
(cfg_strategy_type=='long'?'LONG':'SHORT')+')|'+str.tostring(math.round(glb_current_deal_pnl,cfg_decimals))+
''+str.tostring(syminfo.currency)+'|'+get_timespan_string(glb_dealstart_bar_time,time)
alert(_alert_human,alert.freq_once_per_bar_close)
//weconsiderthatdealclosedwithanySO,ifnotclosedwithSL
elseifcondition_take_profit
array.set(statsarray_safety_orders,count_executed_safety_orders,array.get(statsarray_safety_orders,count_executed_safety_orders)+1)
stats_deals_take_profit_finished:=stats_deals_take_profit_finished+1
//ExtractingPNL.Thisisdifferentcalculationforeachdealclosetype
glb_current_deal_pnl:=strategy.netprofit-glb_strategy_prev_netprofit
glb_strategy_prev_netprofit:=strategy.netprofit
glb_current_deal_close_value:=glb_current_deal_position_size*glb_take_profit_price
glb_total_volume:=glb_total_volume+glb_current_deal_close_value
array.push(statsarray_winning_deals_pnl,glb_current_deal_pnl)
ifcfg_show_pnl_labels
label.new(bar_index,glb_take_profit_price,text=''+str.tostring(math.round(glb_current_deal_pnl,cfg_decimals))+
''+str.tostring(syminfo.currency)+'\n'+get_timespan_string(glb_dealstart_bar_time,time),
yloc=yloc.price,size=size.normal,style=label.style_label_up,textcolor=color.black,color=get_bg_color_green())
//delayedalertaboutdealclosebytakeprofit
_alert_human='D'+str.tostring(stats_deals_started)+'-TP[delayed]('+str.tostring(syminfo.basecurrency)+'_'+
str.tostring(syminfo.currency)+(cfg_strategy_type=='long'?'LONG':'SHORT')+')|'+
str.tostring(math.round(glb_current_deal_pnl,cfg_decimals))+''+str.tostring(syminfo.currency)+
'|'+get_timespan_string(glb_dealstart_bar_time,time)
alert(_alert_human,alert.freq_once_per_bar_close)
elseifcondition_stop_external_indicator

//Thisorderhastobeplacedafterstrategy.cancel_all(),otherwiseitwillgetcanceledaswell
//Itwillgetexecutedonthenextbaropenusingmarketorder
//CancelTPorderifany
ifcfg_enable_bot_controlandcfg_exec_external_indicator
_alert_json=get_3cbot_stopdeal_json()
strategy.order(id='D'+str.tostring(stats_deals_started)+'-EXT-IND',direction=IS_LONG?strategy.short:strategy.long,
qty=math.abs(strategy.position_size),alert_message=_alert_json)
else
//----------------------------
//Iguessthereisnoreasontosendhumanreadablealertstothebot,sothissection
//iscommentedout.Feelfreetore-usethisifyourareinterestedinsendingnotificationsat
//thesametimethestrategyordertriggers
//----------------------------

//_alert_human="D"+tostring(stats_deals_started)+"-EXT-IND("+
//tostring(syminfo.basecurrency)+"_"+tostring(syminfo.currency)+
//(cfg_strategy_type=="long"?"LONG":"SHORT")+")"
//strategy.order(id='D'+str.tostring(stats_deals_started)+'-EXT-IND',direction=IS_LONG?strategy.short:strategy.long,
//qty=math.abs(strategy.position_size),alert_message=_alert_human)

strategy.order(id='D'+str.tostring(stats_deals_started)+'-EXT-IND',direction=IS_LONG?strategy.short:strategy.long,
qty=math.abs(strategy.position_size))



array.set(statsarray_safety_orders,count_executed_safety_orders,array.get(statsarray_safety_orders,count_executed_safety_orders)+1)
stats_deals_take_profit_finished:=stats_deals_take_profit_finished+1
glb_current_deal_close_value:=glb_current_deal_position_size*close
glb_total_volume:=glb_total_volume+glb_current_deal_close_value

//ExtractingPNLbeforethedealisactuallyclosed.Dealwillgetclosedon
//theopenofnextcandle
//Thisisdifferentcalculationforeachdealclosetype
glb_current_deal_pnl:=strategy.openprofit-get_commission_for_volume(glb_current_deal_close_value)

glb_strategy_prev_netprofit:=strategy.netprofit+glb_current_deal_pnl

ifglb_current_deal_pnl>=0
array.push(statsarray_winning_deals_pnl,glb_current_deal_pnl)
else
array.push(statsarray_losing_deals_pnl,glb_current_deal_pnl)

ifcfg_show_pnl_labels
//_text=''+str.tostring(math.round(glb_current_deal_pnl,cfg_decimals))+
//''+str.tostring(syminfo.currency)+'\n'+get_timespan_string(glb_dealstart_bar_time,time)+'\n'
//_text+='strategy.netprofit:'+str.tostring(strategy.netprofit)+'\n'
//_text+='glb_prevnetp:'+str.tostring(glb_strategy_prev_netprofit)+'\n'
//_text+='strategy.openprofit:'+str.tostring(strategy.openprofit)+'\n'
//_text+='glb_current_deal_pnl:'+str.tostring(glb_current_deal_pnl)+'\n'
//label.new(bar_index,close,text="EXT-IND",tooltip=_text,yloc=yloc.price,textalign=text.align_left,
//size=size.normal,style=label.style_label_up,textcolor=color.black,color=get_bg_color_orange())

label.new(bar_index,close,text=''+str.tostring(math.round(glb_current_deal_pnl,cfg_decimals))+
''+str.tostring(syminfo.currency)+'\n'+get_timespan_string(glb_dealstart_bar_time,time),
yloc=yloc.price,size=size.normal,style=label.style_label_up,textcolor=color.black,color=get_bg_color_orange())

//delayedalertaboutdealclosebytakeprofit
_alert_human='D'+str.tostring(stats_deals_started)+'-EXT-IND[delayed]('+str.tostring(syminfo.basecurrency)+'_'+
str.tostring(syminfo.currency)+(cfg_strategy_type=='long'?'LONG':'SHORT')+')|'+
str.tostring(math.round(glb_current_deal_pnl,cfg_decimals))+''+str.tostring(syminfo.currency)+
'|'+get_timespan_string(glb_dealstart_bar_time,time)
alert(_alert_human,alert.freq_once_per_bar_close)
//RESETGLOBALSAFTERDEALCOMPLETION
glb_still_in_deal:=false

lastdeal_close_bar_index:=bar_index
//approximate
lastdeal_close_time:=time
glb_take_profit_price:=na
glb_planb_timeout_price:=na
glb_stop_loss_price:=na
glb_base_order_price:=na
glb_base_order_qty:=na
glb_next_safety_order_price:=na

glb_so_orders_placed:=false

//REMOVED
//glb_next_safety_order_qty:=na

glb_current_deal_position_size:=na

//REMOVED
//glb_current_deal_prev_position_size:=na
glb_current_deal_avg_price:=na
glb_current_deal_close_value:=na
glb_current_deal_pnl:=0
glb_debug_text:=""
debug_printed:=false
glb_dealstart_bar_index:=na
glb_dealstart_bar_time:=na
//REMOVED
//count_placed_safety_orders:=0
count_executed_safety_orders:=0

//label.new(bar_index,low*0.99,text=str.tostring(was_deal_marked_as_finished())+"\n"+str.tostring(strategy.position_size),
//color=color.red)
//----------------------
//PLOTSTUFF
_color_avg_price=theme_text_color
_color_take_profit=get_bg_color_green(90)
ifis_planb_timeout()andcfg_planb_action!='none'
_color_avg_price:=get_bg_color_lightblue()
ifis_planb_timeout()andcfg_planb_action=='closedeal'
_color_take_profit:=get_bg_color_green(100)
p1=plot(glb_take_profit_price,color=get_bg_color_green(),style=plot.style_circles,title='TakeProfit')
p2=plot(strategy.position_avg_price,color=theme_text_color,style=plot.style_circles,title='Dealavgprice')
p3=plot(glb_next_safety_order_price,color=get_bg_color_orange(),style=plot.style_circles,title='Safetyorder')
p4=plot(glb_stop_loss_price,color=get_bg_color_red(),style=plot.style_circles,title='Stoploss')
p5=plot(glb_planb_timeout_price,color=get_bg_color_lightblue(),style=plot.style_circles,title='PLAN-B')
fill(p1,p2,color=_color_take_profit,title='Filltakeprofit')
fill(p2,p3,color=get_bg_color_orange(90),title='Fillsafetyorder')
fill(p2,p5,color=get_bg_color_lightblue(90),title='FillPLAN-B')
//Normallyfillstoplossfromlastsoprice
fill(p3,p4,color=get_bg_color_red(90),title='Fillstoploss')
//IfSOarenotconfiguredorallSOwereexecutedfillSLfromAVGPRICE
_col=(cfg_max_safety_orders==0orna(glb_next_safety_order_price))?get_bg_color_red(90):get_bg_color_red(100)
fill(p2,p4,color=_col,title='Fillstoploss')
//---------------------
//LASTCANDLE-DRAWALLTABLES
ifbarstate.islastconfirmedhistory
glb_required_capital:=get_required_capital()
//ifwearestillinadeal,updatesomestatstocurrentbar
_deal_in_progress=stats_deals_finished<stats_deals_started
if_deal_in_progress
lastdeal_close_bar_index:=bar_index
//approximate
lastdeal_close_time:=time
array.push(statsarray_no_of_bars,bar_index-glb_dealstart_bar_index)
array.push(statsarray_no_of_days,get_days(glb_dealstart_bar_time,time_close))
ifstats_max_days_in_deal<=get_days(glb_dealstart_bar_time,time_close)
stats_max_days_in_deal:=get_days(glb_dealstart_bar_time,time_close)
stats_max_days_in_deal_start_time:=glb_dealstart_bar_time
stats_max_days_in_deal_close_time:=time_close
//----------------------------------------------------------------
//datavalidationandatablewithwarnings
string_text_warnings=''
ifstats_deals_started==0
_text_warnings:=_text_warnings+'-Nodealstarted\n'
ifstats_deals_finished==0
_text_warnings:=_text_warnings+'-Nodealfinished\n'
ifcfg_enable_stop_lossandvalid_stop_loss()==false
_text_warnings:=_text_warnings+'-Stoplossislessthanlastsafetyorder(shouldbemorethan'+str.tostring(math.round(stepped_deviation(cfg_max_safety_orders),2))+'%'+')\n'
ifstepped_deviation(cfg_max_safety_orders)>100
_text_warnings:=_text_warnings+'-Covereddeviationviasafetyordersisover100%\n'
if_text_warnings!=''
tablewarnings=table.new(position.bottom_center,columns=1,rows=2,frame_width=1,frame_color=color.red,border_width=1,border_color=color.red,bgcolor=color.red)
table.cell(warnings,0,0,'WARNINGS!\n(Fixthem,otherwisethestatsareinnacurate)',text_color=color.white,text_halign=text.align_center)
table.cell(warnings,0,1,_text_warnings,text_color=color.white,text_halign=text.align_left)
//----------------------------------------------------------------
//----------------------------------------------------------------
//atablewithbuyingsteps,volumes,pricessimilarto3commas
//setcustomvaluesforboentryprice
ifcfg_show_step_table
ifcfg_steps_bo_price==0orna(cfg_steps_bo_price)
cfg_steps_bo_price:=close

_steps_bo_size=cfg_base_order_size_usd/cfg_steps_bo_price
tablesteps_amount=table.new(position.bottom_left,columns=12,rows=int(cfg_max_safety_orders)+4,frame_width=1,frame_color=color.black,border_width=1,border_color=color.black,bgcolor=color.green)
table.cell(steps_amount,0,0,'Order\nno',text_color=color.white,text_size=size.small)
table.cell(steps_amount,1,0,'Deviation\n(%)',text_color=color.white,text_size=size.small)
table.cell(steps_amount,2,0,'Size\n('+str.tostring(syminfo.basecurrency)+')',text_color=color.white,text_size=size.small)
table.cell(steps_amount,3,0,'Volume\n('+str.tostring(syminfo.currency)+')',text_color=color.white,text_size=size.small)
table.cell(steps_amount,4,0,'Price\n('+str.tostring(syminfo.currency)+')',text_color=color.white,text_size=size.small)
table.cell(steps_amount,5,0,'Avgprice\n('+str.tostring(syminfo.currency)+')',text_color=color.white,text_size=size.small)

table.cell(steps_amount,6,0,'PriceforTP\n('+str.tostring(syminfo.currency)+')',text_color=color.white,text_size=size.small)
table.cell(steps_amount,7,0,'%change\nforTP',text_color=color.white,text_size=size.small)
table.cell(steps_amount,8,0,'%change\nforBEP',text_color=color.white,text_size=size.small)

table.cell(steps_amount,9,0,'Totalsize\n('+str.tostring(syminfo.basecurrency)+')',text_color=color.white,text_size=size.small)
table.cell(steps_amount,10,0,'TotalVol\n('+str.tostring(syminfo.currency)+')',text_color=color.white,text_size=size.small)
float_steps_total_size=_steps_bo_size
float_steps_total_volume=cfg_steps_bo_price*_steps_bo_size
//baseorder
table.cell(steps_amount,0,1,'BO',text_color=color.white,text_size=size.small)
table.cell(steps_amount,1,1,'0',text_color=color.white,text_size=size.small)
table.cell(steps_amount,2,1,str.tostring(math.round(_steps_bo_size,cfg_decimals)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,3,1,str.tostring(math.round(cfg_steps_bo_price*_steps_bo_size,cfg_decimals)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,4,1,str.tostring(math.round(cfg_steps_bo_price,cfg_decimals)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,5,1,str.tostring(math.round(_steps_total_volume/_steps_total_size,cfg_decimals)),text_color=color.white,text_size=size.small)

_req_price_for_tp=steps_required_price(cfg_steps_bo_price,_steps_total_volume/_steps_total_size,_steps_total_size,cfg_take_profit_perc)
table.cell(steps_amount,6,1,str.tostring(math.round(_req_price_for_tp,cfg_decimals)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,7,1,str.tostring(steps_required_percent(cfg_steps_bo_price,_req_price_for_tp)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,8,1,str.tostring(steps_required_percent(cfg_steps_bo_price,cfg_steps_bo_price)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,9,1,str.tostring(math.round(_steps_total_size,cfg_decimals)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,10,1,str.tostring(_steps_total_volume),text_color=color.white,text_size=size.small)
float_steps_next_safety_order_price=0
float_steps_next_safety_order_qty=0
ifcfg_max_safety_orders>0andsafety_order_type=='Percentage'
for_i=1tocfg_max_safety_ordersby1
_steps_next_safety_order_price:=next_so_price(_i,cfg_steps_bo_price)
_steps_next_safety_order_qty:=next_so_qty(_i,cfg_steps_bo_price)
_steps_total_size+=_steps_next_safety_order_qty
_steps_total_volume+=_steps_next_safety_order_qty*_steps_next_safety_order_price
table.cell(steps_amount,0,_i+2,str.tostring(_i),text_color=color.white,text_size=size.small)
table.cell(steps_amount,1,_i+2,str.tostring(stepped_deviation(_i)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,2,_i+2,str.tostring(math.round(_steps_next_safety_order_qty,cfg_decimals)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,3,_i+2,str.tostring(math.round(_steps_next_safety_order_qty*_steps_next_safety_order_price,cfg_decimals)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,4,_i+2,str.tostring(math.round(_steps_next_safety_order_price,cfg_decimals)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,5,_i+2,str.tostring(math.round(_steps_total_volume/_steps_total_size,cfg_decimals)),text_color=color.white,text_size=size.small)

_req_price_for_tp:=steps_required_price(cfg_steps_bo_price,_steps_total_volume/_steps_total_size,_steps_total_size,cfg_take_profit_perc)
table.cell(steps_amount,6,_i+2,str.tostring(math.round(_req_price_for_tp,cfg_decimals)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,7,_i+2,str.tostring(steps_required_percent(_steps_next_safety_order_price,_req_price_for_tp)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,8,_i+2,str.tostring(steps_required_percent(_steps_next_safety_order_price,_steps_total_volume/_steps_total_size)),text_color=color.white,text_size=size.small)

table.cell(steps_amount,9,_i+2,str.tostring(math.round(_steps_total_size,cfg_decimals)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,10,_i+2,str.tostring(_steps_total_volume),text_color=color.white,text_size=size.small)
elseifcfg_max_safety_orders>0
float_steps_next_safety_order_qty_usd=0
for_i=1tocfg_max_safety_ordersby1
_steps_next_safety_order_qty_usd:=next_so_size_usd(_i)
_steps_total_volume+=_steps_next_safety_order_qty_usd
table.cell(steps_amount,0,_i+2,str.tostring(_i),text_color=color.white,text_size=size.small)
table.cell(steps_amount,1,_i+2,"-",text_color=color.white,text_size=size.small)
table.cell(steps_amount,2,_i+2,"-",text_color=color.white,text_size=size.small)
table.cell(steps_amount,3,_i+2,str.tostring(math.round(_steps_next_safety_order_qty_usd,cfg_decimals)),text_color=color.white,text_size=size.small)
table.cell(steps_amount,4,_i+2,"-",text_color=color.white,text_size=size.small)
table.cell(steps_amount,5,_i+2,"-",text_color=color.white,text_size=size.small)
table.cell(steps_amount,6,_i+2,"-",text_color=color.white,text_size=size.small)
table.cell(steps_amount,7,_i+2,"-",text_color=color.white,text_size=size.small)
table.cell(steps_amount,8,_i+2,"-",text_color=color.white,text_size=size.small)
table.cell(steps_amount,9,_i+2,"-",text_color=color.white,text_size=size.small)
table.cell(steps_amount,10,_i+2,str.tostring(_steps_total_volume),text_color=color.white,text_size=size.small)
//----------------------------------------------------------------
//----------------------------------------------------------------
//atablewithallkindofstatisticsaboutstrategyresults
ifcfg_show_stats_table
introwsforstats=array.size(statsarray_safety_orders)+25
tablesostats=table.new(position.top_right,columns=2,rows=rowsforstats,frame_width=1,frame_color=color.black)
_row=0
table.cell(sostats,column=0,row=_row,text='ZendogDCABacktester'+str.tostring(syminfo.basecurrency)+'/'+str.tostring(syminfo.currency),text_halign=text.align_left,text_size=size.small,text_color=color.white,bgcolor=get_bg_color_blue())
table.cell(sostats,column=1,row=_row,text='',text_size=size.small,text_color=color.white,bgcolor=get_bg_color_blue())
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Status:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
if_deal_in_progress
table.cell(sostats,column=1,row=_row,text='Dealinprogress',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_red())
elseifstats_deals_started==0andstats_deals_finished==0
table.cell(sostats,column=1,row=_row,text='Nodeals',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_red())
else
table.cell(sostats,column=1,row=_row,text='Alldealsclosed',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_green())
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Opendeals:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
ifstats_deals_started-stats_deals_finished==0
table.cell(sostats,column=1,row=_row,text='0',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_green())
else
_current_deal_total_value=strategy.position_size*strategy.position_avg_price
_current_deal_actual_value=strategy.position_size*close
float_current_deal_equity_percent=0
ifIS_LONG
_current_deal_equity_percent:=_current_deal_actual_value*100/_current_deal_total_value-100
_current_deal_equity_percent
else
_current_deal_equity_percent:=100-_current_deal_actual_value*100/_current_deal_total_value
_text0=str.tostring(stats_deals_started-stats_deals_finished)+'deal\n'
_text0:=_text0+str.tostring(math.round(strategy.openprofit,cfg_decimals))+''+str.tostring(syminfo.currency)
_text0:=_text0+'('+str.tostring(math.round(_current_deal_equity_percent,2))+'%)\n'
_text0:=_text0+str.tostring(get_timespan_string(glb_dealstart_bar_time,time_close))+',currentlyatSO'+str.tostring(count_executed_safety_orders+1)+'\n'
_text0:=_text0+'(start:'+str.tostring(time_to_date_string(glb_dealstart_bar_time))+')'
table.cell(sostats,column=1,row=_row,text=_text0,text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_red())
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Finisheddeals:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=str.tostring(stats_deals_finished),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Winningdeals:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
ifstats_deals_take_profit_finished==0
table.cell(sostats,column=1,row=_row,text=str.tostring(array.size(statsarray_winning_deals_pnl)),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
else
_text5=''
_text5:=_text5+str.tostring(stats_deals_take_profit_finished)
_text5:=_text5+'('+str.tostring(math.round(array.avg(statsarray_winning_deals_pnl),cfg_decimals))
_text5:=_text5+''+str.tostring(syminfo.currency)+'onavg)'
table.cell(sostats,column=1,row=_row,text=_text5,text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_green())
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Losingdeals:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
ifarray.size(statsarray_losing_deals_pnl)==0
table.cell(sostats,column=1,row=_row,text=str.tostring(array.size(statsarray_losing_deals_pnl)),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_green())
else
_text6=''
_text6:=_text6+str.tostring(array.size(statsarray_losing_deals_pnl))
_text6:=_text6+'('+str.tostring(math.round(array.avg(statsarray_losing_deals_pnl),cfg_decimals))
_text6:=_text6+''+str.tostring(syminfo.currency)+'onavg)'
table.cell(sostats,column=1,row=_row,text=_text6,text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_red())
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Timeoutdeals:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
ifstats_deals_timeout_finished==0
table.cell(sostats,column=1,row=_row,text=str.tostring(stats_deals_timeout_finished),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_green())
else
_text6=''
_text6:=_text6+str.tostring(stats_deals_timeout_finished)
_text6:=_text6+'('+str.tostring(math.round(array.avg(statsarray_timeout_deals_pnl),cfg_decimals))
_text6:=_text6+''+str.tostring(syminfo.currency)+'onavg)'
table.cell(sostats,column=1,row=_row,text=_text6,text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_lightblue())
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Totaltime(Max|Avgtimeindeal):',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_text4=''+str.tostring(get_timespan_string(bh_start_time,bh_end_time))+'('
_text4:=_text4+''+get_timestring_from_days(array.max(statsarray_no_of_days))+'|'
_text4:=_text4+''+get_timestring_from_days(array.avg(statsarray_no_of_days))+')'
table.cell(sostats,column=1,row=_row,text=_text4,text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Totalbacktest:\n'+str.tostring(time_to_date_string(bh_start_time))+'\n'+str.tostring(time_to_date_string(bh_end_time)),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text='Maxdaysindeal:\n'+str.tostring(time_to_date_string(stats_max_days_in_deal_start_time))+'\n'+str.tostring(time_to_date_string(stats_max_days_in_deal_close_time)),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Requiredcapital:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=str.tostring(glb_required_capital)+''+str.tostring(syminfo.currency),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Profit:\n(aftercommision)',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_text1=str.tostring(math.round(get_final_pnl_new(),cfg_decimals))+''+str.tostring(syminfo.currency)
_text1:=_text1+'('+str.tostring(math.round(get_final_pnl_prct_new(),2))+'%)\n'
ifget_days(bh_start_time,bh_end_time)>=1
_text1:=_text1+str.tostring(math.round(get_final_pnl_prct_new()/get_days(bh_start_time,bh_end_time),2))+'%/day'
else
_text1:=_text1+str.tostring(math.round(get_final_pnl_prct_new(),2))+'%/day'
table.cell(sostats,column=1,row=_row,text=_text1,text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
//ifdaterangeislimitedcalculatebetweenstartandenddate
_bh_equity=glb_required_capital/bh_start_price*bh_end_price-glb_required_capital
_bh_commision=get_commission_for_volume(glb_required_capital+glb_required_capital/bh_start_price*bh_end_price)
_bh_equity:=_bh_equity-_bh_commision
_bh_prct_total=math.round(_bh_equity*100/glb_required_capital,2)
table.cell(sostats,column=0,row=_row,text='Buy&holdreturn:\n(aftercommision)',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_text2=str.tostring(math.round(_bh_equity,cfg_decimals))+''+str.tostring(syminfo.currency)
_text2:=_text2+'('+str.tostring(_bh_prct_total)+'%)\n'
ifget_days(bh_start_time,bh_end_time)>=1
_text2:=_text2+str.tostring(math.round(_bh_prct_total/get_days(bh_start_time,bh_end_time),2))+'%/day'
else
_text2:=_text2+str.tostring(math.round(_bh_prct_total,2))+'%/day'
_text2
table.cell(sostats,column=1,row=_row,text=_text2,text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Covereddeviation:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=str.tostring(math.round(stepped_deviation(cfg_max_safety_orders),2))+'%',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
string_bef=valid_stop_loss()?'beforeSL':''
table.cell(sostats,column=0,row=_row,text='Maxdeviation:\n(Dealstartpricevsworstcandle'+_bef+')',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=str.tostring(math.round(stats_biggest_dev,2))+'%\n'+'('+time_to_date_string(stats_biggest_dev_time)+')',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Maxdrawdownfrombreakeven:\n(Avgpricevsworstcandle'+_bef+')',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=str.tostring(math.round(stats_max_drawdown,cfg_decimals))+''+str.tostring(syminfo.currency)+'('+str.tostring(math.round(stats_max_drawdown_equity_percent,2))+'%)\n'+'('+time_to_date_string(stats_max_drawdown_time)+')',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Max#barsindeal:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=str.tostring(array.max(statsarray_no_of_bars)),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Avg#barsindeal:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=str.tostring(math.round(array.avg(statsarray_no_of_bars),2)),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Totalvolume:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=str.tostring(math.round(glb_total_volume,cfg_decimals))+''+str.tostring(syminfo.currency),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
table.cell(sostats,column=0,row=_row,text='Commision:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=str.tostring(math.round(get_commission_for_volume(glb_total_volume),cfg_decimals))+''+str.tostring(syminfo.currency),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
_row:=_row+1
ifarray.size(statsarray_safety_orders)>0
table.cell(sostats,column=0,row=_row,text='Closestatsfor'+str.tostring(stats_deals_finished)+'deals',text_color=color.white,text_size=size.small,bgcolor=get_bg_color_blue(),text_halign=text.align_left)
table.cell(sostats,column=1,row=_row,text='Number(%)/Exitwithtimeout',text_color=color.white,text_size=size.small,bgcolor=get_bg_color_blue())
_row:=_row+1
_saved_row=_row
_row:=_row+2
_max_safety_orders=0
float_avg_safety_orders=0
for_i=0toarray.size(statsarray_safety_orders)-1by1
string_closed_text=''
if_i==0
_closed_text:='BO('+str.tostring(math.round(stepped_deviation(_i),2))+'%)'
else
_closed_text:='SO'+str.tostring(_i)+'('+str.tostring(math.round(stepped_deviation(_i),2))+'%)'
_cnt=array.get(statsarray_safety_orders,_i)
if_cnt>0and_i>_max_safety_orders
_max_safety_orders:=_i
_avg_safety_orders:=_avg_safety_orders+_cnt*_i
table.cell(sostats,column=0,row=_row+_i,text='Closedwith'+_closed_text,text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row+_i))
table.cell(sostats,column=1,row=_row+_i,text=str.tostring(_cnt)+'('+str.tostring(math.round(_cnt*100/stats_deals_finished,2))+'%)/'+str.tostring(array.get(statsarray_safety_orders_timeout,_i)),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row+_i))
_avg_safety_orders:=math.round(_avg_safety_orders/array.sum(statsarray_safety_orders),1)
table.cell(sostats,column=0,row=_saved_row,text='MaxSOused:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_saved_row))
table.cell(sostats,column=1,row=_saved_row,text=str.tostring(_max_safety_orders),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_saved_row))
table.cell(sostats,column=0,row=_saved_row+1,text='AvgSOused:',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_saved_row+1))
table.cell(sostats,column=1,row=_saved_row+1,text=str.tostring(_avg_safety_orders),text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_saved_row+1))
ifvalid_stop_loss()
_row:=_row+array.size(statsarray_safety_orders)
table.cell(sostats,column=0,row=_row,text='ClosedwithStopLoss('+str.tostring(cfg_stop_loss_perc)+'%)',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
table.cell(sostats,column=1,row=_row,text=str.tostring(stats_deals_stop_loss_finished)+'('+str.tostring(math.round(stats_deals_stop_loss_finished*100/stats_deals_finished,2))+'%)',text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=stats_deals_stop_loss_finished>0?get_bg_color_red():get_bg_color_green())
//----------------------------------------------------------------
//----------------------------------------------------------------
ifcfg_show_settings_table
tablesettings=table.new(position.bottom_left,columns=1,rows=2,frame_width=1,frame_color=color.black)
_row=0
table.cell(settings,column=0,row=0,text='DCASettings',text_halign=text.align_left,text_size=size.small,text_color=color.white,bgcolor=get_bg_color_blue())
_text='Type:'+str.tostring(cfg_strategy_type)+';'
_text:=_text+'Commision:'+str.tostring(cfg_commision_percent)+'%;\n'
_text:=_text+'Condition:'+str.tostring(deal_start_type)+''
ifdeal_start_type=='RSI-7'
_text:=_text+str.tostring(rsi_start_operation)
_text:=_text+''+str.tostring(rsi_start_value)+'\n\n'
elseifdeal_start_type=='ExternalIndicator'
_text:=_text+'('
_text:=_text+str.tostring(deal_start_operation)+''
_text:=_text+str.tostring(deal_start_value)
_text:=_text+')\n\n'
_text:=_text+'TP:'+str.tostring(cfg_take_profit_perc)+'%'
_text:=_text+'('+str.tostring(cfg_take_profit_type)+')'
ifcfg_enable_stop_loss
_text:=_text+'\nSL:'+str.tostring(cfg_stop_loss_perc)+'%'
_text:=_text+'\n\n'
_text:=_text+'BO:'+str.tostring(cfg_base_order_size_usd)+''+str.tostring(syminfo.currency)+';'
_text:=_text+'SO:'+str.tostring(cfg_safety_order_size_usd)+''+str.tostring(syminfo.currency)+';\n'
_text:=_text+'SODev:'+str.tostring(cfg_safety_order_price_deviation_perc)+'%;'
_text:=_text+'MaxSO:'+str.tostring(cfg_max_safety_orders)+';'
_text:=_text+'Covered:'+str.tostring(math.round(stepped_deviation(cfg_max_safety_orders),2))+'%;\n'
_text:=_text+'SOVolumeScale:'+str.tostring(cfg_safety_order_volume_scale)+';'
_text:=_text+'SOStepScale:'+str.tostring(cfg_safety_order_price_step_scale)+';\n'

table.cell(settings,column=0,row=1,text=_text,text_halign=text.align_left,text_color=color.black,text_size=size.small,bgcolor=get_bg_color_grey(_row))
//printsomedebugeveryXcandles
//varintlast_bar_debug=0
//ifbar_index-last_bar_debug>20
//last_bar_debug:=bar_index
//_debug_text='strategy.netprofit:'+str.tostring(strategy.netprofit)+'\n'
//_debug_text+='glb_prevnetp:'+str.tostring(glb_strategy_prev_netprofit)+'\n'
//_debug_text+='strategy.openprofit:'+str.tostring(strategy.openprofit)+'\n'
////_debug_text+='glb_prevnetp:'+str.tostring(glb_strategy_prev_netprofit)+'\n'
//label.new(bar_index,close,text="DBG",tooltip=_debug_text,
//yloc=yloc.price,size=size.normal,style=label.style_label_up,textcolor=color.black,color=get_bg_color_lightblue())
//lab=""
//ifarray.size(statsarray_losing_deals_pnl)>0
//lab:=lab+"Losingdeals:\n"
//fori=0toarray.size(statsarray_losing_deals_pnl)-1
//lab:=lab+tostring(array.get(statsarray_losing_deals_pnl,i))+"\n"
//ifarray.size(statsarray_winning_deals_pnl)>0
//lab:=lab+"Winningdeals:\n"
//fori=0toarray.size(statsarray_winning_deals_pnl)-1
//lab:=lab+tostring(array.get(statsarray_winning_deals_pnl,i))+"\n"
//f_print(lab)
//----------------------------------------------------------------
Expand (1584 lines)
